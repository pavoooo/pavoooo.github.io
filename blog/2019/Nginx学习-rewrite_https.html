<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx学习-rewrite_https | 赛赛的空间</title>
    <meta name="description" content="赵赛赛个人博客，关注前端技术，后端技术，喜欢编程。每天进步一点点就好啦！">
    <link rel="icon" type="image/x-icon" href="/blog/favicon.ico">
  <script type="text/javascript" src="/blog/bdtj.js"></script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.626dd732.css" as="style"><link rel="preload" href="/blog/assets/js/app.35f98d9a.js" as="script"><link rel="preload" href="/blog/assets/js/38.e86ba4d5.js" as="script"><link rel="prefetch" href="/blog/assets/js/44.e9171697.js"><link rel="prefetch" href="/blog/assets/js/2.285762ea.js"><link rel="prefetch" href="/blog/assets/js/3.4cb06538.js"><link rel="prefetch" href="/blog/assets/js/4.6daa2d0b.js"><link rel="prefetch" href="/blog/assets/js/5.f169fbdc.js"><link rel="prefetch" href="/blog/assets/js/6.8e18dc59.js"><link rel="prefetch" href="/blog/assets/js/7.9a5a7762.js"><link rel="prefetch" href="/blog/assets/js/8.c79e2e52.js"><link rel="prefetch" href="/blog/assets/js/9.cbe6d4cd.js"><link rel="prefetch" href="/blog/assets/js/10.a3f3e621.js"><link rel="prefetch" href="/blog/assets/js/11.a936e569.js"><link rel="prefetch" href="/blog/assets/js/12.24ea46c0.js"><link rel="prefetch" href="/blog/assets/js/13.ca6cc387.js"><link rel="prefetch" href="/blog/assets/js/14.84cb7623.js"><link rel="prefetch" href="/blog/assets/js/15.17309f98.js"><link rel="prefetch" href="/blog/assets/js/16.85d38bed.js"><link rel="prefetch" href="/blog/assets/js/17.c941d12d.js"><link rel="prefetch" href="/blog/assets/js/18.c1519b3a.js"><link rel="prefetch" href="/blog/assets/js/19.cde47560.js"><link rel="prefetch" href="/blog/assets/js/20.f2b3d7a0.js"><link rel="prefetch" href="/blog/assets/js/21.fb0dfbdc.js"><link rel="prefetch" href="/blog/assets/js/22.add6de0c.js"><link rel="prefetch" href="/blog/assets/js/23.fdc157e1.js"><link rel="prefetch" href="/blog/assets/js/24.9da4875a.js"><link rel="prefetch" href="/blog/assets/js/25.b7f6730b.js"><link rel="prefetch" href="/blog/assets/js/26.d06a49ae.js"><link rel="prefetch" href="/blog/assets/js/27.8bcf44b7.js"><link rel="prefetch" href="/blog/assets/js/28.393e0886.js"><link rel="prefetch" href="/blog/assets/js/29.8f11c87b.js"><link rel="prefetch" href="/blog/assets/js/30.6fa1b714.js"><link rel="prefetch" href="/blog/assets/js/31.cbcfd68a.js"><link rel="prefetch" href="/blog/assets/js/32.6ca69442.js"><link rel="prefetch" href="/blog/assets/js/33.b622ba93.js"><link rel="prefetch" href="/blog/assets/js/34.e6754d06.js"><link rel="prefetch" href="/blog/assets/js/35.4395bfba.js"><link rel="prefetch" href="/blog/assets/js/36.37f57a61.js"><link rel="prefetch" href="/blog/assets/js/37.43d43352.js"><link rel="prefetch" href="/blog/assets/js/39.735fc907.js"><link rel="prefetch" href="/blog/assets/js/40.618bf1ca.js"><link rel="prefetch" href="/blog/assets/js/41.a7d57844.js"><link rel="prefetch" href="/blog/assets/js/42.e79d64a0.js"><link rel="prefetch" href="/blog/assets/js/43.f770ac3d.js"><link rel="prefetch" href="/blog/assets/js/45.4c67e1b4.js"><link rel="prefetch" href="/blog/assets/js/46.91fb5912.js"><link rel="prefetch" href="/blog/assets/js/47.f5aad667.js"><link rel="prefetch" href="/blog/assets/js/48.a2d25018.js"><link rel="prefetch" href="/blog/assets/js/49.0ed30904.js"><link rel="prefetch" href="/blog/assets/js/50.f827e9c9.js"><link rel="prefetch" href="/blog/assets/js/51.adc236a9.js"><link rel="prefetch" href="/blog/assets/js/52.d39ee839.js"><link rel="prefetch" href="/blog/assets/js/53.36d185d9.js"><link rel="prefetch" href="/blog/assets/js/54.6419dcc6.js"><link rel="prefetch" href="/blog/assets/js/55.ccecf702.js"><link rel="prefetch" href="/blog/assets/js/56.d1b793d2.js"><link rel="prefetch" href="/blog/assets/js/57.3d50113f.js"><link rel="prefetch" href="/blog/assets/js/58.9cfcc361.js"><link rel="prefetch" href="/blog/assets/js/59.ff1a4f36.js"><link rel="prefetch" href="/blog/assets/js/60.0f7b8820.js"><link rel="prefetch" href="/blog/assets/js/61.097a07f6.js"><link rel="prefetch" href="/blog/assets/js/62.687bbb7a.js"><link rel="prefetch" href="/blog/assets/js/63.5c593947.js"><link rel="prefetch" href="/blog/assets/js/64.ca67397c.js"><link rel="prefetch" href="/blog/assets/js/65.85dc3f33.js"><link rel="prefetch" href="/blog/assets/js/66.7c1e8c8e.js"><link rel="prefetch" href="/blog/assets/js/67.87b76fe3.js"><link rel="prefetch" href="/blog/assets/js/68.d34efd6f.js"><link rel="prefetch" href="/blog/assets/js/69.cf92857c.js"><link rel="prefetch" href="/blog/assets/js/70.3627cd5e.js"><link rel="prefetch" href="/blog/assets/js/71.570cd009.js"><link rel="prefetch" href="/blog/assets/js/72.c8ad5135.js"><link rel="prefetch" href="/blog/assets/js/73.a2c90bd6.js"><link rel="prefetch" href="/blog/assets/js/74.3f6d014b.js"><link rel="prefetch" href="/blog/assets/js/75.c80dc7fa.js"><link rel="prefetch" href="/blog/assets/js/76.688458b1.js"><link rel="prefetch" href="/blog/assets/js/77.f3cb72dd.js"><link rel="prefetch" href="/blog/assets/js/78.30e9e0da.js"><link rel="prefetch" href="/blog/assets/js/79.7063f38d.js"><link rel="prefetch" href="/blog/assets/js/80.b2f9a366.js"><link rel="prefetch" href="/blog/assets/js/81.a21718cd.js"><link rel="prefetch" href="/blog/assets/js/82.c7aaaf59.js"><link rel="prefetch" href="/blog/assets/js/83.4342b4f3.js"><link rel="prefetch" href="/blog/assets/js/84.98978a64.js"><link rel="prefetch" href="/blog/assets/js/85.d8a362cc.js"><link rel="prefetch" href="/blog/assets/js/86.2b8e3732.js"><link rel="prefetch" href="/blog/assets/js/87.7dfe7fda.js"><link rel="prefetch" href="/blog/assets/js/88.89f412c2.js"><link rel="prefetch" href="/blog/assets/js/89.b362ee77.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.626dd732.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link"><img src="/blog/logo.png" alt="赛赛的空间" class="logo"> <span class="site-name can-hide">赛赛的空间</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/translate.html" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/translate.html" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1>Nginx学习-rewrite_https</h1> <p><code>Nginx</code>允许我们在配置文件中对请求的<code>url</code>根据某些规则进行重写，比如跳转/重定向某个规则。<code>Nginx</code>通过<code>rewrite</code>指令为我们提供这个能力。</p> <h2 id="rewrite"><a href="#rewrite" aria-hidden="true" class="header-anchor">#</a> rewrite</h2> <p><code>rewrite</code>指令语法如下</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">rewrite</span> rule replacement <span class="token punctuation">[</span>flag<span class="token punctuation">]</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span><span class="token punctuation">,</span> <span class="token keyword">if</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><strong>rule</strong>：使用字符串或者正则表达式设置的规则</li> <li><strong>replacement</strong>：规则匹配后要定向的地址。如果使用正则表达式定义规则，则可以在这里使用<code>$1</code>，<code>$2</code>...等获取对应分组中的值</li> <li><strong>flag</strong>：表示重写类型。有如下四种
<ul><li><strong>last</strong>：完成rewrite，但依然会通过新的规则进行匹配</li> <li><strong>break</strong>：本条规则匹配完成后，终止匹配，不再匹配后面的规则</li> <li><strong>redirect</strong>：返回302临时重定向，地址栏会显示跳转后的地址</li> <li><strong>permannet</strong>：返回301永久重定向，地址栏会显示跳转后的地址</li></ul></li></ul> <p>下面是一个简单的<code>rewrite</code>的例子，把所有的请求跳转到<code>/pages/index.html</code>上。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span>pages<span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="正则表达式"><a href="#正则表达式" aria-hidden="true" class="header-anchor">#</a> 正则表达式</h3> <p><code>Nginx</code>的正则表达式的语法和<code>javascript</code>中正则表达式的语法相似，下面是一些常用的元字符</p> <ul><li>.：匹配除换行符之外的任意字符</li> <li>?：重复一次或0次</li> <li>+：重复一次或多次</li> <li>*：重复0次或多次</li> <li>\d：匹配数字</li> <li>^：匹配字符串的开始</li> <li>$：匹配字符串的结尾</li> <li>{n}：重复n次</li> <li>{n,}：重复n次或者多次</li> <li>[c]：匹配单个字符c</li> <li>[a-z]：匹配a-z字符中的任意一个</li> <li>\ ：转义字符</li> <li>()：用于匹配括号之间的内容，通过$1和$2调用</li></ul> <p>掌握了基本的正则表达式后，我们就能够使用正则表达式来书写匹配规则。比如</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span> MSIE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span>msie<span class="token operator">/</span>$<span class="token number">1</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对来自<code>IE</code>浏览器的请求加上<code>/msie</code>前缀。</p> <p>在上面介绍<code>rewrite</code>的重写类型<code>last</code>和<code>break</code>时提到过，二者都能阻止后续的<code>rewrite</code>指令。但<code>last</code>不会终止重写后的<code>url</code>的匹配，即<code>last</code>重写类型会使用重写后的<code>url</code>继续走一遍匹配流程。而<code>break</code>终止匹配后立即以匹配后的资源进行返回。</p> <p>比如</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
	<span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> localhost<span class="token punctuation">;</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>

   <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">rewrite</span> <span class="token operator">/</span>last<span class="token operator">/</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html last<span class="token punctuation">;</span>
        <span class="token keyword">rewrite</span> <span class="token operator">/</span><span class="token keyword">break</span><span class="token operator">/</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>当访问<code>/last/</code>的时候，重写到<code>/index.html</code>，然后使用新的<code>url</code>再进行匹配，命中<code>location = /index.html</code>规则返回<code>400</code></li> <li>当访问<code>/break/</code>的时候，重写到<code>/index.html</code>，不会使用新的<code>url</code>再进行匹配，直接返回<code>/opt/app/code/index.html</code>文件。</li></ul> <h2 id="重定向"><a href="#重定向" aria-hidden="true" class="header-anchor">#</a> 重定向</h2> <p><code>http</code>请求的重定向有两种：</p> <ul><li>301：永久重定向。浏览器会记录重定向后的地址，下次再访问原地址的是不会向服务器发送请求而直接访问重定向的地址</li> <li>302: 临时重定向。每次重定向操作都由<code>server</code>返回<code>302</code>状态码来告诉客户端，客户端再执行重定向操作。</li></ul> <p><code>rewrite</code>指令允许我们在配置文件中对某些<code>url</code>进行重定向操作。<code>redirect</code>表示临时重定向。<code>permannet</code>表示的则是永久重定向。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>

	<span class="token comment"># 配置server中所有的location下的root</span>
	<span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>

  <span class="token comment"># 所有以break开头的路径，rewrite成/test</span>
	<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token keyword">break</span> <span class="token punctuation">{</span>
    <span class="token comment"># 临时重定向</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token keyword">break</span> <span class="token operator">/</span>test redirect<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment"># 所有以last开头的路径，rewrite成/test</span>
	<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>last <span class="token punctuation">{</span>
    <span class="token comment"># 永久重定向</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span>last <span class="token operator">/</span>test permanent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># 所有以last开头的路径，返回json数据</span>
	<span class="token keyword">location</span> <span class="token operator">/</span>test <span class="token punctuation">{</span>
    <span class="token keyword">default_type</span> application<span class="token operator">/</span>json<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">'{&quot;status&quot;: &quot;success&quot;}'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>上面的配置规则在客户端的表现是：当我们访问<code>/break</code>和<code>/last</code>时，都会被重定向到<code>/test</code>。但当我们再次访问<code>/break</code>客户端仍然会向服务端发送请求，然后<code>Nginx</code>再次返回<code>302</code>重定向响应。而再次访问<code>/last</code>的时候，客户端并不会向服务端发送请求，而是直接重定向到<code>/test</code>。</p> <h2 id="https"><a href="#https" aria-hidden="true" class="header-anchor">#</a> https</h2> <p><code>https</code>一般就可认为是<code>http+ssl</code>。其本质就是对传输的数据进行加密以及身份认证。因为<code>http</code>的传输是不安全的，传输的数据容易被中间人盗用，造成信息泄漏。数据的内容也有可能会被劫持和篡改。</p> <h3 id="对称加密和非对称加密"><a href="#对称加密和非对称加密" aria-hidden="true" class="header-anchor">#</a> 对称加密和非对称加密</h3> <p>在<code>https</code>整个加密传输流程中涉及到<strong>对称加密</strong>和<strong>非对称加密</strong>两种加密方法。</p> <ul><li>对称加密</li></ul> <p>加密密钥和解密密钥是相同的</p> <ul><li>非对称加密</li></ul> <p>密钥包含公钥和私钥，公钥加密的数据需要私钥解密，私钥加密的数据需要公钥解密。</p> <h3 id="https协议加密原理"><a href="#https协议加密原理" aria-hidden="true" class="header-anchor">#</a> https协议加密原理</h3> <p><img src="/blog/ng_https1.png" alt></p> <p>客户端首先发起ssl连接(非对称加密)，服务端将公钥发送给客户端。客户端使用这个公钥加密接下来进行对称加密的密码，服务端收到数据后，利用私钥解开接下来需要进行对称加密的密码。后续客户端和服务器会使用对称加密的方式来传输数据。</p> <p>对于上面密钥和数据的传输过程同样是不安全的。首先，在客户端发起ssl连接，服务端将公钥发送给客户端这一过程可能会被中间人劫持。</p> <p><img src="/blog/ng_https2.png" alt></p> <p>对于第一幅图中的数据交换过程，中间人劫持的风险是无法避免的。为了能够有效的避免中间人劫持的风险，我们需要引入一种机制--<code>CA证书</code>。</p> <p><img src="/blog/ng_https3.png" alt></p> <p>服务端向客户端之前发送的是公钥，在引入了CA证书后，服务端向客户端发送的是CA签名证书。客户端会对这个数字证书进行CA校验(和第三方的签名机构进行校验，CA证书中包含了相应的公钥)，如果校验成功则利用公钥加密密码，如果校验失败则停止会话。</p> <h2 id="nginx配置https连接"><a href="#nginx配置https连接" aria-hidden="true" class="header-anchor">#</a> Nginx配置https连接</h2> <p><code>Nginx</code>配置<code>https</code>连接大致会经过以下几个步骤</p> <h3 id="生成密钥"><a href="#生成密钥" aria-hidden="true" class="header-anchor">#</a> 生成密钥</h3> <ul><li><strong>首先保证安装了<code>openssl</code></strong></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>openssl version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>nginx</code>需要开启<code>--with-http_ssl_module</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>nginx -V
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>生成key密钥</strong></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>openssl genrsa -idea -out saisai.key 1024
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>1024 表示加密的位数，位数越高，精度就越高。</p></blockquote> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>Enter pass phrase for saisai.key:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成的过程中需要输入<code>phrase</code>，这个密码一定要记住。</p> <ul><li><strong>生成证书签名请求文件(csr文件)</strong></li></ul> <p>使用上面生成的<code>key</code>文件来生成证书签名请求文件。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>openssl req -new -key saisai.key -out saisai.csr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在生成的过程中会需要输入上述设置的密码，同时需要根据自己的要求填写一些信息。</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:hangzhou
Locality Name (eg, city) [Default City]:hangzhou
Organization Name (eg, company) [Default Company Ltd]:CN
Organizational Unit Name (eg, section) []:mooc
Common Name (eg, your name or your server's hostname) []:
Email Address []:1457358080@qq.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []: 可以为空
An optional company name []:mooc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在工作中，完成了上面两个步骤后，就可以将这两个文件进行打包发送给第三方机构，生成CA证书。个人也可以使用这两个文件建立自签名的CA。</p> <h3 id="生成证书签名文件-ca文件"><a href="#生成证书签名文件-ca文件" aria-hidden="true" class="header-anchor">#</a> 生成证书签名文件(CA文件)</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>openssl x509 -req -days 3650 -in saisai.csr -signkey saisai.key -out saisai.crt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>-days 3650表示的是签名证书的过期时间。不写的话一般默认一个月左右。</p></blockquote> <p>生成的过程中同样需要输入第一步设置的密码,输入完成后，就会生成签名文件了。</p> <h3 id="nginx配置https"><a href="#nginx配置https" aria-hidden="true" class="header-anchor">#</a> Nginx配置https</h3> <p><code>Nginx</code>配置<code>https</code>协议首先确保<code>ssl</code>连接打开。语法如下</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">ssl</span> on <span class="token operator">|</span> off<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token keyword">ssl</span> off<span class="token punctuation">;</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>ssl指令就表示是否开始ssl连接</p></blockquote> <p>然后需要配置<code>ssl</code>证书文件和<code>ssl</code>证书密码文件</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">ssl_certificate</span> file<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>配置ssl的证书文件(.crt文件)</p></blockquote> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">ssl_certificate_key</span> file<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>配置ssl的证书密码文件(.key文件)</p></blockquote> <p>然后就是对<code>Nginx</code>的配置文件进行详细配置</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
	<span class="token keyword">listen</span> <span class="token number">443</span><span class="token punctuation">;</span>
	<span class="token keyword">server_name</span> <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.129</span><span class="token punctuation">;</span>

	<span class="token keyword">ssl</span> on<span class="token punctuation">;</span>
	<span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>ssl_key<span class="token operator">/</span>saisai<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
	<span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>ssl_key<span class="token operator">/</span>saisai<span class="token punctuation">.</span>key<span class="token punctuation">;</span>

	<span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>

	<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
		<span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>重启nginx同样会要求输入上述的phrase密码。重启成功后就可以通过命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">netstat</span> -luntp <span class="token operator">|</span> <span class="token function">grep</span> 443
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看到443的端口被监听</p> <p>然后就可以通过<code>https://192.168.144.129/1.html</code>来访问对应的https页面了。</p> <blockquote><p>你访问的链接可能会收到浏览器的提示，这是因为我们使用的<code>CA</code>证书是自签名的，浏览器无法判断其真实性。</p></blockquote></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/blog/assets/js/38.e86ba4d5.js" defer></script><script src="/blog/assets/js/app.35f98d9a.js" defer></script>
  </body>
</html>
