<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>探探Koa之application | 赛赛的空间</title>
    <meta name="description" content="赵赛赛个人博客，关注前端技术，后端技术，喜欢编程。每天进步一点点就好啦！">
    <link rel="icon" type="image/x-icon" href="/blog/favicon.ico">
  <script type="text/javascript" src="/blog/bdtj.js"></script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.626dd732.css" as="style"><link rel="preload" href="/blog/assets/js/app.292cba89.js" as="script"><link rel="preload" href="/blog/assets/js/49.d5d6bfcf.js" as="script"><link rel="prefetch" href="/blog/assets/js/35.51940a81.js"><link rel="prefetch" href="/blog/assets/js/2.285762ea.js"><link rel="prefetch" href="/blog/assets/js/3.eb00d82f.js"><link rel="prefetch" href="/blog/assets/js/4.a27d6528.js"><link rel="prefetch" href="/blog/assets/js/5.c0cf8aad.js"><link rel="prefetch" href="/blog/assets/js/6.fb30d266.js"><link rel="prefetch" href="/blog/assets/js/7.666695dd.js"><link rel="prefetch" href="/blog/assets/js/8.e66694b3.js"><link rel="prefetch" href="/blog/assets/js/9.90711f11.js"><link rel="prefetch" href="/blog/assets/js/10.5a9086a7.js"><link rel="prefetch" href="/blog/assets/js/11.78c7fc45.js"><link rel="prefetch" href="/blog/assets/js/12.66a77e58.js"><link rel="prefetch" href="/blog/assets/js/13.08487628.js"><link rel="prefetch" href="/blog/assets/js/14.32cf3f5c.js"><link rel="prefetch" href="/blog/assets/js/15.db4abf0f.js"><link rel="prefetch" href="/blog/assets/js/16.4f33b23e.js"><link rel="prefetch" href="/blog/assets/js/17.437b94c9.js"><link rel="prefetch" href="/blog/assets/js/18.05d288a5.js"><link rel="prefetch" href="/blog/assets/js/19.c348a4ea.js"><link rel="prefetch" href="/blog/assets/js/20.6623553b.js"><link rel="prefetch" href="/blog/assets/js/21.d4666b98.js"><link rel="prefetch" href="/blog/assets/js/22.e48810ba.js"><link rel="prefetch" href="/blog/assets/js/23.ed6cc412.js"><link rel="prefetch" href="/blog/assets/js/24.577f562a.js"><link rel="prefetch" href="/blog/assets/js/25.276b33ab.js"><link rel="prefetch" href="/blog/assets/js/26.89ef8495.js"><link rel="prefetch" href="/blog/assets/js/27.b181246a.js"><link rel="prefetch" href="/blog/assets/js/28.9d58c07c.js"><link rel="prefetch" href="/blog/assets/js/29.bf4c8101.js"><link rel="prefetch" href="/blog/assets/js/30.07515fa4.js"><link rel="prefetch" href="/blog/assets/js/31.c2fe32b9.js"><link rel="prefetch" href="/blog/assets/js/32.b1a2243f.js"><link rel="prefetch" href="/blog/assets/js/33.2baf216f.js"><link rel="prefetch" href="/blog/assets/js/34.b8bf5ab1.js"><link rel="prefetch" href="/blog/assets/js/36.cbf04873.js"><link rel="prefetch" href="/blog/assets/js/37.7cdbddfc.js"><link rel="prefetch" href="/blog/assets/js/38.6d86f7ab.js"><link rel="prefetch" href="/blog/assets/js/39.b6bf31dc.js"><link rel="prefetch" href="/blog/assets/js/40.653873ed.js"><link rel="prefetch" href="/blog/assets/js/41.9a7caa65.js"><link rel="prefetch" href="/blog/assets/js/42.9302d0a3.js"><link rel="prefetch" href="/blog/assets/js/43.70d9ee09.js"><link rel="prefetch" href="/blog/assets/js/44.016af569.js"><link rel="prefetch" href="/blog/assets/js/45.935d2711.js"><link rel="prefetch" href="/blog/assets/js/46.a1877bbd.js"><link rel="prefetch" href="/blog/assets/js/47.ba921ee7.js"><link rel="prefetch" href="/blog/assets/js/48.f3cd7492.js"><link rel="prefetch" href="/blog/assets/js/50.335e62ce.js"><link rel="prefetch" href="/blog/assets/js/51.c3061b67.js"><link rel="prefetch" href="/blog/assets/js/52.0dda7953.js"><link rel="prefetch" href="/blog/assets/js/53.0d836dfd.js"><link rel="prefetch" href="/blog/assets/js/54.e15b5c10.js"><link rel="prefetch" href="/blog/assets/js/55.6407d34d.js"><link rel="prefetch" href="/blog/assets/js/56.5a7599c5.js"><link rel="prefetch" href="/blog/assets/js/57.d9952a1f.js"><link rel="prefetch" href="/blog/assets/js/58.6792e92b.js"><link rel="prefetch" href="/blog/assets/js/59.b43f601f.js"><link rel="prefetch" href="/blog/assets/js/60.1e066c04.js"><link rel="prefetch" href="/blog/assets/js/61.47fd03bb.js"><link rel="prefetch" href="/blog/assets/js/62.f64fb6a8.js"><link rel="prefetch" href="/blog/assets/js/63.3774cdc6.js"><link rel="prefetch" href="/blog/assets/js/64.048594bc.js"><link rel="prefetch" href="/blog/assets/js/65.4fbb0553.js"><link rel="prefetch" href="/blog/assets/js/66.0e06d96f.js"><link rel="prefetch" href="/blog/assets/js/67.a190deb4.js"><link rel="prefetch" href="/blog/assets/js/68.76b04703.js"><link rel="prefetch" href="/blog/assets/js/69.f179918c.js"><link rel="prefetch" href="/blog/assets/js/70.bc4e401a.js"><link rel="prefetch" href="/blog/assets/js/71.95a772a7.js"><link rel="prefetch" href="/blog/assets/js/72.2bcfa7f1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.626dd732.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link"><img src="/blog/logo.png" alt="赛赛的空间" class="logo"> <span class="site-name can-hide">赛赛的空间</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/translate.html" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/translate.html" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1>探探Koa之application</h1> <p><code>Koa</code>启动<code>http</code>服务是十分简单的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> ctx <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello koa'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>一般来说，就如下三个主要的步骤：</p> <ul><li>创建<code>Koa</code>实例 —— new Koa</li> <li>添加中间件 —— app.use()</li> <li>启动服务 —— app.listen</li></ul> <h2 id="构造函数"><a href="#构造函数" aria-hidden="true" class="header-anchor">#</a> 构造函数</h2> <p>我们创建<code>Koa</code>服务的第一步就是创建<code>Koa</code>实例，这也就表明了<code>Koa</code>是一个类。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token keyword">extends</span> <span class="token class-name">Emitter</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>从上述源码中可以看到，<code>Koa</code>继承自<code>Emitter</code>，所以，我们可以在<code>Koa</code>实例上监听任意我们想要监听的事件。比如</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 监听一个自定义事件</span>
app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> someEventListener<span class="token punctuation">)</span>

<span class="token comment">// 设置error监听器</span>
app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> yourErrorHandler<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这也就是为什么我们可以在<code>app</code>对象上通过监听<code>error</code>事件监听我们应用运行过程中发生的错误，一般<code>error</code>事件是不需要我们主动触发的，<code>Koa</code>会在我们的应用发生错误的时候，主动触发这个事件。我们所需要做的就是在事件回调中自定义我们的错误处理逻辑。</p> <p>当我们创建<code>app</code>实例的时候，<code>constructor</code>方法会被调用。这时，会在<code>app</code>实例上添加如下属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subdomainOffset <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><p><strong>proxy</strong>：这个属性主要就是用来告诉<code>Koa</code>，我们的请求是否会经过代理服务器。如果把这个属性设置为<code>true</code>，<code>Koa</code>在后续处理请求的时候，会优先处理和代理相关的特性，后续会说到。</p></li> <li><p><strong>middleware</strong>：这个属性是一个内部属性，一般是不需要从外部直接访问的。它主要是用来保存我们传递给<code>app</code>实例的中间件方法的。</p></li> <li><p><strong>subdomainOffset</strong>：这个属性在我们获取子域名信息的时候有用。默认为2，比如，我们的子域是<code>api.internal.domain.baidu.com</code>。则</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>subdomains <span class="token comment">// ['api', 'internal']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>后续会详细讲解获取过程。</p> <ul><li><p><strong>env</strong>：设置<code>Koa</code>服务运行时候的环境变量，和<code>process.env.NODE_ENV</code>相等。</p></li> <li><p><strong>context</strong>：基于<code>context</code>文件中暴露出来的对象为原型创建一个对象，这样我们可以通过<code>app.context</code>获取<code>context</code>上的属性和方法</p></li> <li><p><strong>request</strong>：含义同上</p></li> <li><p><strong>response</strong>：含义同上</p></li></ul> <p>上面就是创建实例的过程中的一些操作。实例创建结束后，我们需要做的就是通过<code>app.use</code>方法添加我们的中间件函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">use</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 参数必须是函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'middleware must be a function!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果说是generator函数，就将generator函数转化为async 函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGeneratorFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token string">'Support for generators will be removed in v3. '</span> <span class="token operator">+</span>
              <span class="token string">'See the documentation for examples of how to convert old middleware '</span> <span class="token operator">+</span>
              <span class="token string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fn <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'use %s'</span><span class="token punctuation">,</span> fn<span class="token punctuation">.</span>_name <span class="token operator">||</span> fn<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将我们添加的中间件函数保存在</span>
  <span class="token comment">// app.middleware属性中</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回当前app实例，这个返回结果保证了use方法的链式调用。</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>use</code>方法的实现很简单，接收一个函数作为参数。首先判断参数是不是<code>generator</code>函数，这个主要是为了兼容一些只支持<code>Koa@1</code>的中间件。<code>generator</code>形式的参数会通过<code>koa-convert</code>方法进行转换，将其转换成<code>Koa@2</code>所支持的<code>promise</code>风格的函数。之后，将这个中间件函数保存在<code>app.middleware</code>属性中。</p> <p>上面就是<code>use</code>的实现过程，下面才是真正的启动<code>http</code>服务的操作。当我们调用<code>app.listen</code>方法的时候，<code>http</code>服务才会真正的启动。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'listen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>调用<code>app.listen</code>其实就是通过<code>http.createServer</code>方法创建一个<code>server</code>实例，然后通过<code>server.listen</code>监听特定的端口。而且<code>app.listen</code>接受和<code>server.listen</code>相同的参数。这里需要注意的是<code>createServer</code>方法的参数，这个参数是调用<code>app.callback</code>方法的返回值。在了解<code>callback</code>方法的实现之前，我们也应该能猜出这个方法的返回值肯定是<code>(req, res) =&gt; {}</code>形式的函数。下面是<code>callback</code>方法的具体实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果我们没有注册error事件，Koa会为我们注册一个默认的error事件，并绑定默认的错误处理函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 这个函数就是在创建http服务的时候被调用的函数，req和res就是我们的http请求和响应对象
     */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 启动服务的第一步就是通过app.createContext来创建请求上下文对象，也就是我们通常所说的ctx</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这个方法其实就是设置了默认的响应状态，以及对中间件执行结果进行了相应的处理</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>callback</code>方法首先通过<code>compose</code>函数对传入的中间件进行组合。<code>compose</code>的具体实现可以通过<a href="https://www.npmjs.com/package/koa-compose" target="_blank" rel="noopener noreferrer">koa-compose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>了解。这里为了方便大家理解，就实现一个包含其核心内容的简易版本。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// 当前中间件的执行索引</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> fn <span class="token operator">=</span> middlewares<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> middlewares<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fn <span class="token operator">=</span> next
      <span class="token punctuation">}</span>
      <span class="token comment">// 中间件执行完毕</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dispatch<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">++</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 首先执行第一个中间件</span>
    <span class="token comment">// 如果在某个中间件的内部调用了next，其实就是调用dispatch(index + 1)</span>
    <span class="token comment">// 表示执行下一个中间件</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>compose</code>函数是一个高阶函数，接受中间件数组作为参数，返回一个函数，这个函数也是<code>callback</code>方法中声明的<code>fn</code>变量。当调用这个函数的时候，会将我们熟知的<code>ctx</code>对象作为第一个参数传递进去，然后从第一个中间件开始“递归”的调用所有的中间件。这里的“递归”只是形式上的递归，因为所有的中间件函数需要我们手动调用才会继续向下递归运行。看一下<code>componse</code>函数中<code>dispatch</code>函数的返回值</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dispatch<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">++</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里的<code>fn</code>是对<code>middleware</code>数组中元素的引用，也就是我们的中间件函数。我们在添加中间件的时候</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第二个参数<code>next</code>就是对<code>dispatch.bind(null, ++index)</code>函数的引用。这也就是为什么我们需要在中间件函数中调用<code>next</code>，才会执行下一个中间件函数。</p> <p>组合中间件后，<code>Koa</code>会检查<code>app</code>是否注册了<code>error</code>事件。如果没有注册，则为<code>app</code>注册一个默认的<code>error</code>事件，并绑定默认的错误处理回调函数。这个回调函数的内容，后续会讲。</p> <p>接着创建<code>handleRequest</code>函数并返回，这个函数就作为<code>http.createServer</code>的参数来启动服务。当有请求到来的时候，这个函数会先调用<code>app.createContext</code>方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 基于context.js为原型，创建context对象</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 基于request.js 为原型，创建request对象</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 基于response.js为原型 创建response对象</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> context<span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>app <span class="token operator">=</span> request<span class="token punctuation">.</span>app <span class="token operator">=</span> response<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>req <span class="token operator">=</span> request<span class="token punctuation">.</span>req <span class="token operator">=</span> response<span class="token punctuation">.</span>req <span class="token operator">=</span> req<span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>res <span class="token operator">=</span> request<span class="token punctuation">.</span>res <span class="token operator">=</span> response<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>
  request<span class="token punctuation">.</span>ctx <span class="token operator">=</span> response<span class="token punctuation">.</span>ctx <span class="token operator">=</span> context<span class="token punctuation">;</span>
  request<span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
  response<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
  <span class="token comment">// 关系错综复杂</span>
  <span class="token comment">// 在context和request设置原始url的属性</span>
  <span class="token comment">// 原始的url不包含protocol和host部分</span>
  context<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> request<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
  <span class="token comment">// 设置ctx.state属性</span>
  context<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>app.createContext</code>方法就是用来创建我们所熟知的<code>ctx</code>对象的。这个方法的内部主要是建立了<code>app</code>，<code>context</code>，<code>request</code>，<code>response</code>，<code>req</code>，<code>res</code>等六个对象之间的关系。这六者的详细关系在<a href="https://zhaosaisai.com/blog/2019/%E6%8E%A2%E6%8E%A2Koa.html#%E5%85%B3%E7%B3%BB%E5%9B%BE" target="_blank" rel="noopener noreferrer">探探Koa<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中已经叙述，具体的细节请查看上文。同时，在<code>ctx</code>对象上添加了如下两个属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> req<span class="token punctuation">.</span>url

ctx<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接着调用<code>app.handleRequest</code>并以上文创建的<code>ctx</code>对象和组合后的中间件函数<code>fn</code>作为参数来处理请求。<em>(中间件你就可以看作是操作ctx对象的过程，在这个过程中会对请求和响应进行处理)</em>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fnMiddleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ctx.res就是对原始http请求的res的引用</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
  <span class="token comment">// 默认的状态码是404 在没有设置响应体的情况下的状态码</span>
  <span class="token comment">// 一旦设置了ctx.body 就会被设置为200</span>
  res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行中间件过程中的错误处理函数</span>
  <span class="token comment">// 执行中间件过程，如果出现了错误，使用context上下文中的错误捕获进行处理</span>
  <span class="token keyword">const</span> <span class="token function-variable function">onerror</span> <span class="token operator">=</span> err <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 中间件之行结束后，处理响应的函数</span>
  <span class="token comment">// 中间件其实就是对ctx对象的一些基本的操作</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleResponse</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO: onFinished判断</span>
  <span class="token function">onFinished</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 从第1个中间件开始，依次递归执行所有的中间件。</span>
  <span class="token keyword">return</span> <span class="token function">fnMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>app.handleRequest</code>的主要功能就是执行中间件函数并响应。首先获取到原生<code>http</code>响应对象<code>res</code>，同时设置默认的响应状态码为<code>404</code>。这里的默认状态码只是一个临时状态，当我们设置<code>ctx.body</code>属性的时候，<code>res.statusCode</code>属性会被重写。如果你在整个流程中都没有设置<code>ctx.body</code>的值，返回的状态码就是<code>404</code>。这合情合理又合法。</p> <p>接着创建<code>onerror</code>和<code>handleResponse</code>函数。其中<code>handleResponse</code>是用来处理正常响应的，而<code>onerror</code>则会调用<code>ctx.onerror</code>来处理错误。这里的错误不仅包含<strong>中间件执行过程中的错误</strong>也包含<strong>用户自己抛出的错误</strong>。后面在讲解<code>context</code>的时候会讲解这个方法的实现。下面，我们看一下<code>respond</code>是怎么处理正常的响应的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">===</span> ctx<span class="token punctuation">.</span>respond<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取原生的http 响应对象</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>writable<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> ctx<span class="token punctuation">.</span>status<span class="token punctuation">;</span>

  <span class="token comment">// ignore body</span>
  <span class="token comment">// 如果状态码标识忽略响应体。则将ctx.body 设置为空，并返回一个空响应。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>statuses<span class="token punctuation">.</span>empty<span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// strip headers</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// head方法一般是不需要返回响应体的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'HEAD'</span> <span class="token operator">==</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>headersSent <span class="token operator">&amp;&amp;</span> <span class="token function">isJSON</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 响应体的长度应该是字节的长度</span>
      ctx<span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// status body</span>
  <span class="token comment">// 没有设置ctx.body的情况下</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// req.httpVersionMajor 返回 HTTP 版本的第一个整数值</span>
    <span class="token comment">// req.httpVersionMinor 返回 HTTP 版本的第二个整数值。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>httpVersionMajor <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// http2</span>
      body <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// http1的情况下 取ctx.message 或者 code作为默认值</span>
      body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token function">String</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 没有设置body的情况下</span>
    <span class="token comment">// 默认content-type是application/text</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>headersSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text'</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// responses</span>
  <span class="token comment">// 下面就是对body分各种形式进行响应</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'string'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> body<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token keyword">instanceof</span> <span class="token class-name">Stream</span><span class="token punctuation">)</span> <span class="token keyword">return</span> body<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// body: json</span>
  body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>headersSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 响应前先设置响应体的长度</span>
    ctx<span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>这个函数接收<code>ctx</code>对象作为参数。首先判断<code>ctx.respond</code>是否为<code>true</code>，如果这个值为<code>true</code>，则说明用户不想让<code>Koa</code>来处理<code>http</code>响应，这种情况下，用户需要自己操作<code>res</code>对象来处理响应。接着会判断<code>ctx.writable</code>属性，这个属性其实是<code>ctx.response.writable</code>。后续在讲解<code>response</code>的时候会讲解这个属性的细节，这里我们只需要知道在<code>ctx.writable</code>为<code>false</code>的情况下，<code>Koa</code>是不会为我们处理响应的。</p> <p>接着获取<code>ctx.status</code>，这个属性其实就是我们设置的响应状态码<code>res.statusCode</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>statuses<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">null</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果状态码的含义表示响应体为空，则不管我们是否设置了<code>ctx.body</code>，都会为客户端返回一个空的响应体。那哪些状态码需要响应体为空呢？这里我们需要看一下<code>statuses.empty</code>是怎么实现的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// status codes for empty bodies</span>
status<span class="token punctuation">.</span>empty <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">204</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">205</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">304</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>statuses</code>在三种状态码的情况下认为服务端应该返回一个空的响应体。这三种状态码的含义如下：</p> <ul><li><strong>204（No Content）</strong>：响应首部包含若干首部和一个状态行，但没有实体的主体部分。主要用于在浏览器不转为显示新文档的情况下，对其进行更新（比如刷新一个表单页面）</li> <li><strong>205（Reset Content）</strong>：负责高速浏览器清除当前页面中的所有<code>HTML</code>表单元素。</li> <li><strong>304（Not Modified）</strong>：如果客户端发起一个条件<code>GET</code>请求，而最近资源没有更改的话，就可以用这个状态码来说明资源未被修改，客户端可以直接从缓存中获取数据。</li></ul> <p>接着会判断请求是否为<code>HEAD</code>请求。如果是，则在响应头未发送的时候设置<code>Content-Length</code>的值。因为<code>json</code>类型的响应数据，服务器无法直接判断<code>Content-Length</code>的长度，需要我们明确设置。同时，返回客户端一个空的响应体。</p> <p>下面是如果在<code>ctx.body</code>的属性值为<code>null</code>的情况。根据上面的描述，这种情况下，服务器响应的状态码为<code>404</code>。这里我们就需要根据客户端<code>http</code>的版本为客户端设置一个默认的响应体。在<code>http2</code>的情况下，响应体就是<code>statusCode</code>的字符串形式，在<code>http1.x</code>的版本下，则会根据响应状态码确定状态描述信息后座位响应体返回客户端。比如，默认情况下的状态码是<code>404</code>，则对应的响应体就是<code>Not Found</code>。同时设置<code>Content-Type</code>为<code>text/plain</code>响应客户端。</p> <p>最后，就根据我们设置的<code>ctx.body</code>的类型进行不同形式的响应。在<code>Buffer</code>或者<code>String</code>类型的时候，通过<code>res.end</code>方法响应客户端。在<code>Stream</code>类型下，直接通过<code>pipe</code>方法将数据传递给<code>res</code>对象，因为原生的<code>http</code>响应对象也是可写流的一种。如果响应体是对象，需要先进行序列化，因为<code>res.end</code>不能以对象作为参数。同时设置<code>Content-Length</code>的长度，响应客户端。</p> <div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>Content-Length表示的是字节的长度而不是字符的长度，所以设置的时候通过Buffer.byteLength方法来确定数据的字节长度</p></div> <p>最后再一起看一下<code>Koa</code>为<code>app</code>绑定的<code>error</code>事件默认的回调函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'non-error thrown: %j'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">404</span> <span class="token operator">==</span> err<span class="token punctuation">.</span>status <span class="token operator">||</span> err<span class="token punctuation">.</span>expose<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>silent<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> msg <span class="token operator">=</span> err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^/gm</span><span class="token punctuation">,</span> <span class="token string">'  '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这个错误回调处理程序默认只是将错误信息输出到终端上。当然，为了我们程序的健壮性，我们需要设定自己的<code>app.on('error')</code>事件处理程序。</p> <p>以上就是对<code>Koa</code>的<code>application</code>版块进行的解读，后面我们会接着对<code>Koa</code>的<code>context</code>对象进行解读。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/blog/assets/js/49.d5d6bfcf.js" defer></script><script src="/blog/assets/js/app.292cba89.js" defer></script>
  </body>
</html>
