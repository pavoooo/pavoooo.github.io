<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>travis自动化部署github项目到server | 赛赛的空间</title>
    <meta name="description" content="赵赛赛个人博客，关注前端技术，后端技术，喜欢编程。每天进步一点点就好啦！">
    <link rel="icon" type="image/x-icon" href="/blog/favicon.ico">
  <script type="text/javascript" src="/blog/bdtj.js"></script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.626dd732.css" as="style"><link rel="preload" href="/blog/assets/js/app.0ea7d7fe.js" as="script"><link rel="preload" href="/blog/assets/js/45.4605741e.js" as="script"><link rel="prefetch" href="/blog/assets/js/33.3aa36fd0.js"><link rel="prefetch" href="/blog/assets/js/2.285762ea.js"><link rel="prefetch" href="/blog/assets/js/3.8614e950.js"><link rel="prefetch" href="/blog/assets/js/4.5b21cfc0.js"><link rel="prefetch" href="/blog/assets/js/5.51c10059.js"><link rel="prefetch" href="/blog/assets/js/6.61ae1162.js"><link rel="prefetch" href="/blog/assets/js/7.064379bd.js"><link rel="prefetch" href="/blog/assets/js/8.c5d69357.js"><link rel="prefetch" href="/blog/assets/js/9.be2af9e9.js"><link rel="prefetch" href="/blog/assets/js/10.771d9939.js"><link rel="prefetch" href="/blog/assets/js/11.469637f2.js"><link rel="prefetch" href="/blog/assets/js/12.24ea46c0.js"><link rel="prefetch" href="/blog/assets/js/13.b8a8bb01.js"><link rel="prefetch" href="/blog/assets/js/14.136e0562.js"><link rel="prefetch" href="/blog/assets/js/15.f7efc203.js"><link rel="prefetch" href="/blog/assets/js/16.f96fe5dc.js"><link rel="prefetch" href="/blog/assets/js/17.0dc87cac.js"><link rel="prefetch" href="/blog/assets/js/18.738e6596.js"><link rel="prefetch" href="/blog/assets/js/19.82ba4217.js"><link rel="prefetch" href="/blog/assets/js/20.03cfef0d.js"><link rel="prefetch" href="/blog/assets/js/21.8047be57.js"><link rel="prefetch" href="/blog/assets/js/22.f54c4be8.js"><link rel="prefetch" href="/blog/assets/js/23.7bb6c916.js"><link rel="prefetch" href="/blog/assets/js/24.db04b710.js"><link rel="prefetch" href="/blog/assets/js/25.1f1b4027.js"><link rel="prefetch" href="/blog/assets/js/26.71c35cdf.js"><link rel="prefetch" href="/blog/assets/js/27.0bb1e48e.js"><link rel="prefetch" href="/blog/assets/js/28.27aa51e8.js"><link rel="prefetch" href="/blog/assets/js/29.f6c1ed44.js"><link rel="prefetch" href="/blog/assets/js/30.20bacd83.js"><link rel="prefetch" href="/blog/assets/js/31.ee9866cf.js"><link rel="prefetch" href="/blog/assets/js/32.3ea3634c.js"><link rel="prefetch" href="/blog/assets/js/34.3b50836a.js"><link rel="prefetch" href="/blog/assets/js/35.60fdbc70.js"><link rel="prefetch" href="/blog/assets/js/36.8f538b89.js"><link rel="prefetch" href="/blog/assets/js/37.a711d483.js"><link rel="prefetch" href="/blog/assets/js/38.4520a6bc.js"><link rel="prefetch" href="/blog/assets/js/39.2c5ceffe.js"><link rel="prefetch" href="/blog/assets/js/40.57a7af4f.js"><link rel="prefetch" href="/blog/assets/js/41.afe753b3.js"><link rel="prefetch" href="/blog/assets/js/42.eee98816.js"><link rel="prefetch" href="/blog/assets/js/43.aed79c9c.js"><link rel="prefetch" href="/blog/assets/js/44.03235065.js"><link rel="prefetch" href="/blog/assets/js/46.79581a4e.js"><link rel="prefetch" href="/blog/assets/js/47.6c44dd80.js"><link rel="prefetch" href="/blog/assets/js/48.c50503fb.js"><link rel="prefetch" href="/blog/assets/js/49.15ea82f8.js"><link rel="prefetch" href="/blog/assets/js/50.e78a50c5.js"><link rel="prefetch" href="/blog/assets/js/51.b9e5cc0a.js"><link rel="prefetch" href="/blog/assets/js/52.4f8c52f6.js"><link rel="prefetch" href="/blog/assets/js/53.842b8bc1.js"><link rel="prefetch" href="/blog/assets/js/54.d9861648.js"><link rel="prefetch" href="/blog/assets/js/55.d26639c5.js"><link rel="prefetch" href="/blog/assets/js/56.2df2dd18.js"><link rel="prefetch" href="/blog/assets/js/57.28414308.js"><link rel="prefetch" href="/blog/assets/js/58.98468863.js"><link rel="prefetch" href="/blog/assets/js/59.5a85de82.js"><link rel="prefetch" href="/blog/assets/js/60.b4d3c095.js"><link rel="prefetch" href="/blog/assets/js/61.0554426a.js"><link rel="prefetch" href="/blog/assets/js/62.51d455a1.js"><link rel="prefetch" href="/blog/assets/js/63.302692c6.js"><link rel="prefetch" href="/blog/assets/js/64.9dbd1627.js"><link rel="prefetch" href="/blog/assets/js/65.02b50942.js"><link rel="prefetch" href="/blog/assets/js/66.5bdb3c3d.js"><link rel="prefetch" href="/blog/assets/js/67.a3258da7.js"><link rel="prefetch" href="/blog/assets/js/68.fbc462e2.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.626dd732.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link"><img src="/blog/logo.png" alt="赛赛的空间" class="logo"> <span class="site-name can-hide">赛赛的空间</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/webkit.html" class="nav-link">Webkit</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/webkit.html" class="nav-link">Webkit</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1>travis自动化部署github项目到server</h1> <p><code>travis</code>是目前市场上比较流行的进行持续集成服务的工具之一。所谓的持续集成就是说只要代码有变更，它就能够自动的进行构建，测试，发布等一系列的流程。<code>travis</code>能够和我们<code>github</code>上的项目进行绑定，一旦我们项目对应分支上的内容发生变化，它就能自动的进行持续集成服务，把变更同步到远程服务器上。这就使下面的开发流程成为了可能</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>本地项目开发 --<span class="token operator">&gt;</span>
推送变更到github --<span class="token operator">&gt;</span>
travis监测到内容变化 --<span class="token operator">&gt;</span>
自动拉取最新代码 --<span class="token operator">&gt;</span>
基于最新代码进行构建，测试 --<span class="token operator">&gt;</span>
所有流程成功后，同步到我们自己的远程服务器 --<span class="token operator">&gt;</span>
触发远程服务器上的构建和部署等工作
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面的流程中只有前两步需要我们手工操作，后面的一系列流程都是通过持续集成服务自动完成，这可以让我们只关注于业务开发即可。这篇文章的目的就是从零构建一个项目，通过持续集成服务自动部署到服务器，最后，利用<code>Nginx</code>实现项目的可访问。</p> <h2 id="环境准备"><a href="#环境准备" aria-hidden="true" class="header-anchor">#</a> 环境准备</h2> <ul><li><code>github</code>一个权限是<code>public</code>的项目(<code>travis</code>对<code>private</code>的项目收费)</li> <li>云服务器(<code>travis</code>可连接)</li> <li>终端连接工具(我用的是<code>iTerm</code>)</li></ul> <h2 id="创建项目"><a href="#创建项目" aria-hidden="true" class="header-anchor">#</a> 创建项目</h2> <p>首先在<code>github</code>上创建一个<code>public</code>项目，创建的过程这里就不再详述，创建成功后，克隆到本地。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/zhaosaisai/publish-system.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>后面我会以自己的项目<code>publish-system</code>来演示整个过程，实际操作的时候，需要换成自己的项目。</p></blockquote> <p>然后，进入到项目中。为了能够演示完整的流程，这里我就先把项目初始化一个<code>vue</code>工程</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cd</span> publish-system
vue init webpack-simple <span class="token keyword">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>把变更推送到远程<code>master</code>分支</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> add <span class="token keyword">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;Init project&quot;</span>
<span class="token function">git</span> push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>实际开发中我们一般会有一些开发分支，这些分支稳定后会合并到<code>master</code>上。这里主要是因为后面<code>travis</code>监听的就是<code>master</code>分支的变化，为了方便，我这里就直接在<code>master</code>分支上进行操作了。</p></blockquote> <p>项目初始化好以后，接下来需要做的工作就是将我们的<code>github</code>工程和<code>travis</code>关联起来</p> <h2 id="绑定travis"><a href="#绑定travis" aria-hidden="true" class="header-anchor">#</a> 绑定<code>travis</code></h2> <p>使用自己的<code>github</code>用户登录<a href="https://travis-ci.org/" target="_blank" rel="noopener noreferrer">https://travis-ci.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，登录成功后，<code>travis</code>会自动帮我们同步所有的<code>github</code>工程。找到需要<code>travis</code>进行构建的项目，打开后面的开关。</p> <p><img src="/blog/travis4.png" alt></p> <h3 id="添加-travis-yml"><a href="#添加-travis-yml" aria-hidden="true" class="header-anchor">#</a> 添加.travis.yml</h3> <p>上面的开关打开后，<code>travis</code>就会监听这个仓库的所有的变化。但是<code>travis</code>并不知道在仓库发生变化后需要做什么，这里就要求我们需要在对应项目的根目录下面创建一个<code>.travis.yml</code>文件。这是<code>travis</code>的配置文件，里面描述了<code>travis</code>需要做的各种行为，这个文件必须放在项目的根目录下面，一旦项目发生变化，<code>travis</code>就会根据这个文件的配置去做各种操作。所以，在这里我们需要在项目的根目录下面添加一个<code>.travis.yml</code>文件。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">touch</span> .travis.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后添加如下内容</p> <div class="language-yml line-numbers-mode"><pre class="language-text"><code>language: node_js
node_js:
- 8
branches:
  only:
  - master
script:
- echo &quot;build&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这个文件告诉<code>travis</code>这个项目是一个<code>noed.js</code>的项目，使用的<code>node.js</code>的版本是<code>@8</code>，只有当<code>master</code>分支发生变化的时候才会去执行构建任务，这里只是简单的运行了一条命令<code>echo &quot;build&quot;</code>。</p> <p>将内容的变更推送到远程仓库的<code>master</code>分支上，这时你就能发现<code>travis</code>开始根据<code>.travis.yml</code>中的配置进行持续集成的工作了。构建结束后，就能在网页中的终端控制台中看到<code>script</code>的执行结果了</p> <p><img src="/blog/travis5.png" alt></p> <h2 id="ssh免密登录远程服务器"><a href="#ssh免密登录远程服务器" aria-hidden="true" class="header-anchor">#</a> ssh免密登录远程服务器</h2> <p>之前的步骤没有什么难以理解的地方，到此，我们能够实现项目变更后<code>travis</code>能够自动进行一些持续集成的任务了。但我们所希望的是在持续集成结束后<code>travis</code>能够自动将更新同步到我们的远程服务器或者通知我们的服务器进行更新同步。这种操作首先需要解决的就是<code>travis</code>能够连接我们的远程服务器。但<code>travis</code>不像我们本地的交互式终端，输入用户名和密码后就能登录到服务器。另一方面，这一操作也不能完全自动化的去完成。所以，我们只能利用其它的方式让<code>travis</code>能够自动登录到我们的服务器。这种方式就是我们即将提到的<strong>ssh免密登录</strong>。</p> <p><strong>ssh免密登录</strong>利用的是<strong>非对称加密</strong>的方式。基本步骤就是</p> <ul><li>在客户端生成<code>公钥</code>和<code>私钥</code></li> <li>然后将<code>私钥</code>保存在客户端的<code>~/.ssh/id_rsa</code>中，将<code>公钥</code>保存在服务器的<code>~/.ssh/authorized_keys</code>文件中</li></ul> <p>更改文件的权限后，我们就能直接通过<code>ssh</code>免密登录我们的服务器。但是我们是无法操作<code>travis</code>的客户端的，但是如果我们了解<code>ssh</code>免密登录的原理后，你会发现公钥和私钥在什么地方生成都行，最重要的是两个要成对。</p> <blockquote><p>ssh免密登录的大致过程就是：客户端向服务器发起登录请求，服务器向客户端返回一段随机字符串，客户端收到这段字符串后使用自己的私钥进行加密，然后发给服务器。服务器接收后使用自己保存的公钥解密，如果解密后的数据相等就登录成功，否则断开连接。</p></blockquote> <p>所以，公钥和私钥的生成我们完全可以在自己的服务器上进行操作。首先，登录到自己的服务器</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ssh</span> root@118.24.204.202
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成密钥对之前，我们先创建一个<code>travis</code>连接的用户</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 添加publish用户</span>
<span class="token function">useradd</span> publish
<span class="token comment"># 添加密码</span>
<span class="token function">passwd</span> publish
<span class="token comment"># 添加sudoer权限</span>
vim /etc/sudoers

<span class="token comment"># 加入 </span>
<span class="token comment"># publish  ALL=(ALL)   ALL</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接着，切换到<code>publish</code>用户</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">su</span> publish
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面开始进行密钥对的生成</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ ssh-keygen -t rsa

Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/home/publish/.ssh/id_rsa<span class="token punctuation">)</span>:
Created directory <span class="token string">'/home/publish/.ssh'</span><span class="token keyword">.</span>
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>:
Enter same passphrase again:
Your identification has been saved <span class="token keyword">in</span> /home/publish/.ssh/id_rsa.
Your public key has been saved <span class="token keyword">in</span> /home/publish/.ssh/id_rsa.pub.
The key fingerprint is:
b6:c5:e8:4a:6a:e8:63:e9:79:47:c6:77:a2:24:be:3f publish@VM_0_12_centos
The key's randomart image is:
+--<span class="token punctuation">[</span> RSA 2048<span class="token punctuation">]</span>----+
<span class="token operator">|</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>         o       <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token keyword">.</span>  S o      <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token keyword">.</span> <span class="token operator">=</span>ooo.      <span class="token operator">|</span>
<span class="token operator">|</span>   + <span class="token operator">=</span>.ooo       <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token operator">=</span>.+oE.         <span class="token operator">|</span>
<span class="token operator">|</span> +++o+o.         <span class="token operator">|</span>
+-----------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>Enter passphrase 这一步直接设置为空</p></div> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 然后就会发现加目录下面的.ssh目录中多了两个文件</span>
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ ll ~/.ssh/
总用量 8
-rw------- 1 publish publish 1679 3月   3 10:04 id_rsa
-rw-r--r-- 1 publish publish  404 3月   3 10:04 id_rsa.pub
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> -al
总用量 28
drwx------  3 publish publish 4096 3月   3 10:04 <span class="token keyword">.</span>
drwxr-xr-x. 3 root    root    4096 2月  27 21:27 <span class="token punctuation">..</span>
-rw-------  1 publish publish  500 3月   3 10:05 .bash_history
-rw-r--r--  1 publish publish   18 8月   3 2016 .bash_logout
-rw-r--r--  1 publish publish  193 8月   3 2016 .bash_profile
-rw-r--r--  1 publish publish  231 8月   3 2016 .bashrc
drwx------  2 publish publish 4096 3月   3 10:04 .ssh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>密钥生成后，我们需要更改<code>.ssh</code>和<code>.ssh/*</code>的权限。一般设置<code>.ssh</code>的权限是<code>700</code>(可能默认就是)，<code>.ssh/*</code>的权限是<code>600</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> 600 ~/.ssh/*
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ ll ~/.ssh/
总用量 8
-rw------- 1 publish publish 1679 3月   3 10:04 id_rsa
-rw------- 1 publish publish  404 3月   3 10:04 id_rsa.pub
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后将生成的公钥(<code>id_rsa.pub</code>)中的内容添加到<code>.ssh/authorized_keys</code>中</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">touch</span> ~/.ssh/authorized_keys
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">&gt;&gt;</span>  ~/.ssh/authorized_keys
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">cat</span>  ~/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCt28duvuem+0YweqQA4gzOhEJEv7uPgl6btH<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>到此，密钥对已经生成完成。下面，我们就需要测试一下免密登录的操作是否能成功。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ <span class="token function">touch</span> config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后在<code>config</code>中添加如下内容</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Host <span class="token function">test</span>
<span class="token comment"># 你需要登录的主机ip</span>
HostName 118.24.204.202
<span class="token comment"># 你需要登录的用户名</span>
User publish

IdentitiesOnly <span class="token function">yes</span>

IdentityFile ~/.ssh/id_rsa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>HostName需要换成自己的</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ ll
总用量 12
-rw-rw-r-- 1 publish publish  404 3月   3 10:09 authorized_keys
-rw-rw-r-- 1 publish publish    0 3月   3 10:11 config
-rw------- 1 publish publish 1679 3月   3 10:04 id_rsa
-rw------- 1 publish publish  404 3月   3 10:04 id_rsa.pub
<span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ <span class="token function">ssh</span> <span class="token function">test</span>
Bad owner or permissions on /home/publish/.ssh/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>运行<code>ssh test</code>后报错<code>Bad owner or permissions on /home/publish/.ssh/config</code>。这里同样要求我们要把<code>.ssh/config</code>和<code>.ssh/authorized_keys</code>权限设置为<code>600</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ <span class="token function">chmod</span> 600 config
<span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ <span class="token function">chmod</span> 600 authorized_keys
<span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ ll
总用量 12
-rw------- 1 publish publish  404 3月   3 10:09 authorized_keys
-rw------- 1 publish publish    0 3月   3 10:11 config
-rw------- 1 publish publish 1679 3月   3 10:04 id_rsa
-rw------- 1 publish publish  404 3月   3 10:04 id_rsa.pub
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后执行<code>ssh test</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos .ssh<span class="token punctuation">]</span>$ <span class="token function">ssh</span> <span class="token function">test</span>
The authenticity of host <span class="token string">'118.24.204.202 (118.24.204.202)'</span> can<span class="token string">'t be established.
ECDSA key fingerprint is a3:d8:b0:f6:cb:6f:c0:f6:9a:4e:e5:6c:69:35:d6:fd.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span>118.24.204.202' <span class="token punctuation">(</span>ECDSA<span class="token punctuation">)</span> to the list of known hosts.
Last login: Sun Mar  3 10:00:35 2019 from 115.193.184.147

<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> .ssh/
authorized_keys  config  id_rsa  id_rsa.pub  known_hosts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>出现上面输出就表示我们的免密登录配置成功，同时在<code>.ssh/</code>下多了一个<code>known_hosts</code>文件。</p> <p>下面我们就需要将上面的密钥对中的私钥放在<code>travis</code>上，但是我们是无法直接操作<code>travis</code>服务器的，因此我们也就不能将私钥放在<code>travis</code>服务器上。但是，我们可以将私钥放在<code>travis</code>服务器能够读取的地方，因为<code>travis</code>是能够直接读取我们项目的工程的，所以，我们可以将私钥放在我们的项目中，<code>travis</code>提供了对私钥进行加密的功能，我们可以将私钥加密之后放在我们的工程中，当<code>travis</code>需要连接我们的服务器时，就解密这个私钥用于连接。</p> <h2 id="安装travis客户端"><a href="#安装travis客户端" aria-hidden="true" class="header-anchor">#</a> 安装travis客户端</h2> <p><code>travis</code>是通过<code>gem</code>进行安装的，<code>gem</code>是<code>ruby</code>的管理工具。所以我们需要先安装<code>ruby</code>，安装<code>ruby</code>我们可以使用<code>ruby</code>的版本控制工具<code>rvm</code>，它就相当于我们<code>Node</code>界中的<code>nvm</code>。</p> <h3 id="安装rvm"><a href="#安装rvm" aria-hidden="true" class="header-anchor">#</a> 安装rvm</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> -sSL https://get.rvm.io <span class="token operator">|</span> <span class="token function">bash</span> -s stable
Downloading https://github.com/rvm/rvm/archive/1.29.7.tar.gz
Downloading https://github.com/rvm/rvm/releases/download/1.29.7/1.29.7.tar.gz.asc
gpg: 已创建目录‘/home/publish/.gnupg’
gpg: 新的配置文件‘/home/publish/.gnupg/gpg.conf’已建立
gpg: 警告：在‘/home/publish/.gnupg/gpg.conf’里的选项于此次运行期间未被使用
gpg: 钥匙环‘/home/publish/.gnupg/pubring.gpg’已建立
gpg: 于 2019年01月04日 星期五 06时01分48秒 CST 创建的签名，使用 RSA，钥匙号 39499BDB
gpg: 无法检查签名：没有公钥
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>安装的过程中可能因为签名的问题而失败，我们只需要按照它的提示运行响应的命令即可</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ gpg2 --keyserver hkp://pool.sks-keyservers.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">source</span> /home/publish/.rvm/scripts/rvm
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ rvm --version
rvm 1.29.7 <span class="token punctuation">(</span>latest<span class="token punctuation">)</span> by Michal Papis, Piotr Kuczynski, Wayne E. Seguin <span class="token punctuation">[</span>https://rvm.io<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>rvm</code>安装成功后，我们就可以安装<code>ruby</code>了</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ rvm <span class="token function">install</span> ruby <span class="token comment"># 安装过程有点慢</span>
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ ruby -v
ruby 2.6.0p0 <span class="token punctuation">(</span>2018-12-25 revision 66547<span class="token punctuation">)</span> <span class="token punctuation">[</span>x86_64-linux<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>ruby</code>安装成功后，<code>gem</code>也就安装成功了。和<code>npm</code>同样因为防火墙的问题，我们需要将<code>gem</code>源切换成国内的</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ gem sources -l
*** CURRENT SOURCES ***

https://rubygems.org/
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ gem -v
3.0.1
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/
https://gems.ruby-china.com/ added to sources
https://rubygems.org/ removed from sources
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ gem sources -l
*** CURRENT SOURCES ***

https://gems.ruby-china.com/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>然后就能安装<code>travis</code>客户端了</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ gem <span class="token function">install</span> travis
Shell completion not installed. Would you like to <span class="token function">install</span> it now? <span class="token operator">|</span>y<span class="token operator">|</span> y
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ travis <span class="token function">help</span>
Usage: travis COMMAND <span class="token punctuation">..</span>.

Available commands:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果有上面的输出，就说明<code>travis</code>客户端已经在我们的服务器上安装成功了。下面，我们需要将项目克隆到我们的服务器上</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> projects
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">cd</span> projects/
<span class="token punctuation">[</span>publish@VM_0_12_centos projects<span class="token punctuation">]</span>$ <span class="token function">git</span> clone https://github.com/zhaosaisai/publish-system.git
<span class="token punctuation">[</span>publish@VM_0_12_centos projects<span class="token punctuation">]</span>$ <span class="token function">cd</span> publish-system/
<span class="token punctuation">[</span>publish@VM_0_12_centos publish-system<span class="token punctuation">]</span>$ <span class="token function">ls</span> -al
总用量 40
drwxrwxr-x 3 publish publish 4096 3月   3 10:46 <span class="token keyword">.</span>
drwxrwxr-x 3 publish publish 4096 3月   3 10:46 <span class="token punctuation">..</span>
drwxrwxr-x 8 publish publish 4096 3月   3 10:46 .git
-rw-rw-r-- 1 publish publish  914 3月   3 10:46 .gitignore
-rw-rw-r-- 1 publish publish  208 3月   3 10:46 index.html
-rw-rw-r-- 1 publish publish 1071 3月   3 10:46 LICENSE
-rw-rw-r-- 1 publish publish  919 3月   3 10:46 package.json
-rw-rw-r-- 1 publish publish  343 3月   3 10:46 README.md
-rw-rw-r-- 1 publish publish  164 3月   3 10:46 .travis.yml
-rw-rw-r-- 1 publish publish 2457 3月   3 10:46 webpack.config.js

<span class="token comment"># 在项目根目录下 执行　travis的login操作</span>
<span class="token punctuation">[</span>publish@VM_0_12_centos publish-system<span class="token punctuation">]</span>$ travis login
We need your GitHub login to identify you.
This information will not be sent to Travis CI, only to api.github.com.
The password will not be displayed.

Try running with --github-token or --auto <span class="token keyword">if</span> you don't want to enter your password anyway.

Username: zhaosaisai
Password <span class="token keyword">for</span> zhaosaisai: ***********
Successfully logged <span class="token keyword">in</span> as zhaosaisai<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>同样使用<code>github</code>的账户登录<code>travis</code>，然后，先来看看<code>.travis.yml</code>文件的内容</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos publish-system<span class="token punctuation">]</span>$ <span class="token function">cat</span> .travis.yml
<span class="token comment"># 指定项目开发语言</span>
language: node_js
<span class="token comment"># 指定node的版本</span>
node_js:
  - 8
<span class="token comment"># 指定触发构建的分支</span>
branches:
  only:
  - master

script:
- <span class="token keyword">echo</span> <span class="token string">'build'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>接着对上面生成的私钥进行加密</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos publish-system<span class="token punctuation">]</span>$ travis encrypt-file ~/.ssh/id_rsa  --add
Detected repository as zhaosaisai/publish-system, is this correct? <span class="token operator">|</span><span class="token function">yes</span><span class="token operator">|</span> <span class="token function">yes</span>
encrypting /home/publish/.ssh/id_rsa <span class="token keyword">for</span> zhaosaisai/publish-system
storing result as id_rsa.enc
storing secure <span class="token function">env</span> variables <span class="token keyword">for</span> decryption

Make sure to add id_rsa.enc to the <span class="token function">git</span> repository.
Make sure not to add /home/publish/.ssh/id_rsa to the <span class="token function">git</span> repository.
Commit all changes to your .travis.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后，你就会发现在项目的根目录下多了一个<code>id_rsa.enc</code>文件以及<code>.travis.yml</code>多了一个<code>before_install</code>指令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
<span class="token punctuation">[</span>publish@VM_0_12_centos publish-system<span class="token punctuation">]</span>$ <span class="token function">ls</span> -al
总用量 44
drwxrwxr-x 3 publish publish 4096 3月   3 10:50 <span class="token keyword">.</span>
drwxrwxr-x 3 publish publish 4096 3月   3 10:46 <span class="token punctuation">..</span>
drwxrwxr-x 8 publish publish 4096 3月   3 10:50 .git
-rw-rw-r-- 1 publish publish  914 3月   3 10:46 .gitignore
-rw-rw-r-- 1 publish publish 1680 3月   3 10:50 id_rsa.enc
-rw-rw-r-- 1 publish publish  208 3月   3 10:46 index.html
-rw-rw-r-- 1 publish publish 1071 3月   3 10:46 LICENSE
-rw-rw-r-- 1 publish publish  919 3月   3 10:46 package.json
-rw-rw-r-- 1 publish publish  343 3月   3 10:46 README.md
-rw-rw-r-- 1 publish publish  223 3月   3 10:50 .travis.yml
-rw-rw-r-- 1 publish publish 2457 3月   3 10:46 webpack.config.js

<span class="token punctuation">[</span>publish@VM_0_12_centos publish-system<span class="token punctuation">]</span>$ <span class="token function">cat</span> .travis.yml
language: node_js
node_js:
- 8
branches:
  only:
  - master
script:
- <span class="token keyword">echo</span> <span class="token string">'build'</span>
before_install:
- openssl aes-256-cbc -K <span class="token variable">$encrypted_ff98517d7fe4_key</span> -iv <span class="token variable">$encrypted_ff98517d7fe4_iv</span>
  -in id_rsa.enc -out ~\/.ssh/id_rsa -d

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>然后将变更推送到远程<code>master</code>分支上，同样会触发<code>travis</code>自动构建的工作。但是这次构建你可能会发现如下的错误</p> <p><img src="/blog/travis.png" alt></p> <p>这是因为<code>travis</code>的<code>1.8.8</code>以上的客户端有一个bug，生成的命令的<code>-out</code>选项的值多了一个<code>\</code>，这会导致报错：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> ~/.ssh/id_rsa: No such <span class="token function">file</span> or directory
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以，我们手动将<code>before_install</code>中<code>-out</code>选项的值中多余的<code>\</code>删除即可。</p> <div class="language-yml line-numbers-mode"><pre class="language-text"><code>before_install:
- openssl aes-256-cbc -K $encrypted_ff98517d7fe4_key -iv $encrypted_ff98517d7fe4_iv
  -in id_rsa.enc -out ~/.ssh/id_rsa -d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后将变更推送到远程<code>master</code>分支，就不会出现上述错误了，<code>travis</code>同样也会构建成功。</p> <h2 id="登录命令"><a href="#登录命令" aria-hidden="true" class="header-anchor">#</a> 登录命令</h2> <p>到此，我们就差最后一个步骤了：在<code>.travis.yml</code>中添加登录服务器的命令。下面是我完整的<code>.travis.yml</code>内容</p> <div class="language-yml line-numbers-mode"><pre class="language-text"><code>language: node_js
node_js:
- 8
branches:
  only:
  - master
install:
- yarn install 
script:
- yarn run build
before_install:
- openssl aes-256-cbc -K $encrypted_****_key -iv $encrypted_****_iv
  -in id_rsa.enc -out ~/.ssh/id_rsa -d
addons:
  ssh_known_hosts:
  - 118.24.204.202
after_success:
- chmod 600 ~/.ssh/id_rsa
- ssh publish@118.24.204.202 -o StrictHostKeyChecking=no 'cd ~/projects &amp;&amp; ./sync_publish_system.sh'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>有两个注意事项：</p> <ul><li>ssh_known_hosts需要换成你自己的ip</li> <li>ssg命令需要加上<strong>StrictHostKeyChecking=no</strong>选项，具体的可以查看<a href="http://www.worldhello.net/2010/04/08/1026.html" target="_blank" rel="noopener noreferrer">禁用ssh远程主机的公钥检查<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>至此，我们就完成了当项目变更推送到<code>master</code>分支后，自动触发<code>travis</code>自动安装，构建等工作。构建成功后，自动登录到我的服务器，进入到<code>~/projects</code>目录中执行<code>./sync_publish_system.sh</code>脚本。</p> <p>下面是我的<code>sync_publish_system.sh</code>的内容</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos projects<span class="token punctuation">]</span>$ <span class="token function">cat</span> sync_publish_system.sh
<span class="token comment">#!/usr/bin/env bash</span>

<span class="token keyword">set</span> -euxo pipefail

<span class="token comment"># 输出版本信息</span>
<span class="token keyword">echo</span> -e <span class="token string">&quot;\033[32m <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> version<span class="token variable">)</span></span> \033[0m&quot;</span>

<span class="token comment"># 设置git配置相关的信息</span>
<span class="token function">git</span> config --global user.name <span class="token string">&quot;zhaosaisai&quot;</span>
<span class="token function">git</span> config --global user.email <span class="token string">&quot;zhaosaisai@u51.com&quot;</span>

<span class="token comment"># 进入到publish-system</span>
<span class="token function">cd</span> ~/projects/publish-system

<span class="token comment"># 获取最新内容</span>
<span class="token function">git</span> pull origin master

<span class="token comment"># 安装和构建</span>
yarn <span class="token function">install</span>
yarn run build

<span class="token keyword">exit</span> 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><blockquote><p>你可以在安装和构建的过程中添加更过的操作，比如进行测试等环节。</p></blockquote> <h2 id="服务器安装node环境"><a href="#服务器安装node环境" aria-hidden="true" class="header-anchor">#</a> 服务器安装<code>Node</code>环境</h2> <p>我的服务器的<code>Node</code>环境很简单</p> <ul><li>安装<code>nvm</code></li> <li>安装<code>Node</code></li> <li>安装<code>yarn</code></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> -o- https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh <span class="token operator">|</span> <span class="token function">bash</span>
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ nvm -h
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ nvm <span class="token function">install</span> 8
Downloading and installing node v8.15.1<span class="token punctuation">..</span>.
Downloading https://nodejs.org/dist/v8.15.1/node-v8.15.1-linux-x64.tar.xz<span class="token punctuation">..</span>.
<span class="token comment">######################################################################## 100.0%</span>
Computing checksum with sha256sum
Checksums matched<span class="token operator">!</span>
Now using node v8.15.1 <span class="token punctuation">(</span>npm v6.4.1<span class="token punctuation">)</span>
Creating default alias: default -<span class="token operator">&gt;</span> 8 <span class="token punctuation">(</span>-<span class="token operator">&gt;</span> v8.15.1<span class="token punctuation">)</span>
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">which</span> node
~/.nvm/versions/node/v8.15.1/bin/node
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ node -v
v8.15.1
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">npm</span> -v
6.4.1
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ <span class="token function">npm</span> <span class="token function">install</span> yarn -g
/home/publish/.nvm/versions/node/v8.15.1/bin/yarn -<span class="token operator">&gt;</span> /home/publish/.nvm/versions/node/v8.15.1/lib/node_modules/yarn/bin/yarn.js
/home/publish/.nvm/versions/node/v8.15.1/bin/yarnpkg -<span class="token operator">&gt;</span> /home/publish/.nvm/versions/node/v8.15.1/lib/node_modules/yarn/bin/yarn.js
+ yarn@1.13.0
added 1 package <span class="token keyword">in</span> 2.66s
<span class="token punctuation">[</span>publish@VM_0_12_centos ~<span class="token punctuation">]</span>$ yarn -v
1.13.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="安装nginx"><a href="#安装nginx" aria-hidden="true" class="header-anchor">#</a> 安装Nginx</h2> <p>在<code>travis</code>持续集成服务技术后，我们可以通过<code>Nginx</code>来提供对我们的项目的访问，关于<code>Nginx</code>的安装可以查看<a href="https://zhaosaisai.com/blog/2019/Nginx%E5%AD%A6%E4%B9%A0-%E5%AE%89%E8%A3%85_%E5%9F%BA%E6%9C%AC%E6%A8%A1%E5%9D%97_%E8%AF%B7%E6%B1%82%E9%99%90%E5%88%B6_%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6.html" target="_blank" rel="noopener noreferrer">Nginx学习-安装_基本模块_请求限制_访问限制
<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>安装成功后，在<code>nginx</code>的配置文件中添加如下规则</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>publish<span class="token operator">-</span>system <span class="token punctuation">{</span>
    <span class="token keyword">alias</span> <span class="token operator">/</span>home<span class="token operator">/</span>publish<span class="token operator">/</span>projects<span class="token operator">/</span>publish<span class="token operator">-</span>system<span class="token punctuation">;</span>
    <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>dist <span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span>publish<span class="token operator">-</span>system<span class="token operator">/</span>$<span class="token number">1</span> last<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>重启<code>nginx</code>，访问<code>http://118.24.204.202/publish-system/</code>就能看到我们从零开始的项目，通过持续集成构建后，可以成功访问了。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/blog/assets/js/45.4605741e.js" defer></script><script src="/blog/assets/js/app.0ea7d7fe.js" defer></script>
  </body>
</html>
