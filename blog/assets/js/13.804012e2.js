(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{191:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"content"},[n("h1",[s._v("redux源码解读－－createStore源码解析")]),s._v(" "),s._m(0),s._v(" "),n("p",[s._v("先看一下这个模块的基本结构：")]),s._v(" "),s._m(1),s._v(" "),s._m(2),s._v(" "),s._m(3),s._v(" "),s._m(4),s._v(" "),s._m(5),s._v(" "),s._m(6),s._v(" "),s._m(7),s._v(" "),s._m(8),s._m(9),s._m(10),s._v(" "),s._m(11),s._m(12),s._v(" "),s._m(13),n("p",[s._v("下面就来一点点分析每一行代码到底做什么：")]),s._v(" "),s._m(14),s._m(15),s._v(" "),s._m(16),s._v(" "),s._m(17),s._v(" "),s._m(18),n("p",[s._v("这个时候就会执行上面源码中的代码，使函数调用满足最基本的形式调用。也就是函数在传递两个或者三个参数的情况下，其内部处理逻辑都是一样的。")]),s._v(" "),s._m(19),s._m(20),s._v(" "),s._m(21),s._m(22),s._m(23),s._v(" "),s._m(24),s._m(25),s._m(26),s._v(" "),s._m(27),s._m(28),s._v(" "),n("p",[s._v("首先，我们必须要知道的事情就是：我们的监听器在什么时候会执行？在我们的调用dispatch派发action之后。ok，看下面的这个图：")]),s._v(" "),s._m(29),s._v(" "),s._m(30),s._v(" "),s._m(31),s._v(" "),s._m(32),s._v(" "),s._m(33),n("p",[s._v("结果是：")]),s._v(" "),s._m(34),s._m(35),s._v(" "),s._m(36),s._v(" "),s._m(37),s._v(" "),n("p",[s._v("下面接着扯：")]),s._v(" "),s._m(38),s._m(39),s._m(40),n("p",[s._v("这就是对"),n("code",[s._v("createStore")]),s._v("源码的一个整体解读，水平有限，欢迎拍砖。后续的源码解读和测试例子可以关注："),n("a",{attrs:{href:"https://github.com/SourceCooode/__redux",target:"_blank",rel:"noopener noreferrer"}},[s._v("redux源码解读仓库"),n("OutboundLink")],1)])])},[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("p",[n("code",[s._v("createStore")]),s._v("是"),n("code",[s._v("redux")]),s._v("最核心的模块。这个模块就是用于创建一个"),n("code",[s._v("store")]),s._v("对象，同时，对外暴露出"),n("code",[s._v("dispatch")]),s._v(","),n("code",[s._v("getState")]),s._v(","),n("code",[s._v("subscribe")]),s._v("和"),n("code",[s._v("replaceReducer")]),s._v("方法。(源码中关于"),n("code",[s._v("observable")]),s._v("的部分可以忽略，这个是"),n("code",[s._v("redux")]),s._v("内部使用的。我们在开发中几乎几乎用不到)")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("img",{attrs:{src:"/blog/redux2.png",alt:"redux"}})])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("strong",[this._v("依赖")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[t("code",[this._v("lodash/isPlainObject")])]),this._v(" "),t("li",[t("code",[this._v("symbol-observable")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("strong",[this._v("对外输出")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ul",[n("li",[n("code",[s._v("dispatch")])]),s._v(" "),n("li",[n("code",[s._v("getState")])]),s._v(" "),n("li",[n("code",[s._v("subscribe")])]),s._v(" "),n("li",[n("code",[s._v("replaceReducer")])]),s._v(" "),n("li",[n("code",[s._v("[$$observable]")]),s._v("(几乎不用)")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("blockquote",[n("p",[s._v("redux源码中使用的"),n("code",[s._v("lodash/isPlainObject")]),s._v("依赖。在"),n("code",[s._v("IE6-8")]),s._v("中性能很差，其实现方式和"),n("code",[s._v("jQuery3.x")]),s._v("的实现相似，在旧版本的"),n("code",[s._v("IE")]),s._v("中支持不了。最后会和大家一起探讨。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("em",[this._v("源码注释")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 判断是不是纯粹对象的模块({})")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("import")]),s._v(" isPlainObject "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'lodash/isPlainObject'")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 引入observable支持")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("import")]),s._v(" $$observable "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'symbol-observable'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" ActionTypes "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token constant"}},[s._v("INIT")]),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'@@redux/INIT'")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("p",[s._v("上面这个是"),n("code",[s._v("redux")]),s._v("内部使用的一个"),n("code",[s._v("action")]),s._v("。主要用于内部测试和渲染初始的state。记住，我们自己编写"),n("code",[s._v("action")]),s._v("的时候，"),n("code",[s._v("action.type")]),s._v("不能为"),n("code",[s._v("@@redux/INIT")]),s._v("。因为，这个action会在"),n("code",[s._v("redux")]),s._v("的内部自动调用。比如，下面的捣蛋代码：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("createStore"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" combineReducers"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" applyMiddleware"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'../src'")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logger "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'redux-logger'")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" actionTypes "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'@@redux/INIT'")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{attrs:{class:"token function-variable function"}},[s._v("reducers")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" action"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("switch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("case")]),s._v(" actionTypes"),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      console"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'hello @@redux/INIT'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token string"}},[s._v("'type'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" actionTypes\n      "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("default")]),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" state\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" store "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("createStore")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reducers"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("applyMiddleware")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsole"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'*************************************'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsole"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("store"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getState")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token comment"}},[s._v("//会渲染为 {'type': '@@redux/INIT'}")]),s._v("\nconsole"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'*************************************'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("下面就是"),t("code",[this._v("createStore")]),this._v("方法的实现：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("createStore")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reducer"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" preloadedState"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" enhancer"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("//...初始条件的判断和设定")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("getState")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// getState方法的实现")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("subscribe")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// subscribe方法的实现")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("dispatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// dispatch方法的实现")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("replaceReducer")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// replaceReducer方法的实现")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("observable")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// observable方法的实现")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("// store被创建后，自动分发一个'INIT' action。渲染出初始化的state树。")]),s._v("\n  "),n("span",{attrs:{class:"token function"}},[s._v("dispatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" type"),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ActionTypes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token constant"}},[s._v("INIT")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" preloadedState "),n("span",{attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'function'")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" enhancer "),n("span",{attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  enhancer "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" preloadedState\n  preloadedState "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" undefined\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("在调用"),t("code",[this._v("createStore")]),this._v("的方法的时候，可以传递三个参数"),t("code",[this._v("createStore(reducer, preloadedState, enhancer)")]),this._v("。其中,各参数属性如下：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ul",[n("li",[n("code",[s._v("reducer")]),s._v("必需参数，"),n("code",[s._v("function")]),s._v("类型")]),s._v(" "),n("li",[n("code",[s._v("preloadedState")]),s._v("可选参数，"),n("code",[s._v("object")]),s._v("类型")]),s._v(" "),n("li",[n("code",[s._v("enhancer")]),s._v("可选参数，"),n("code",[s._v("function")]),s._v("类型")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("在平常的使用中，我们一般会省略第二个参数。比如，当我们需要使用"),t("code",[this._v("redux中间件的时候")]),this._v("，就会像第三个参数传递一个"),t("code",[this._v("applyMiddleware()")]),this._v("[返回值是一个"),t("code",[this._v("function")]),this._v("]。如果，我们没有初始状态，则会省略第二个参数。这个时候，我们的函数调用形式为：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" store "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("createStore")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reducer"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("applyMiddleware")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token operator"}},[s._v("...")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 如果我们指定了reducer增强器enhancer")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" enhancer "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("// enhancer必须是一个函数")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" enhancer "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'function'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'Expected the enhancer to be a function.'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{attrs:{class:"token comment"}},[s._v("// 这个函数接收createStore作为参数，并且返回一个函数，这个函数接收的参数是reducer,preloadedState")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 直接返回经过enhancer包装的对象")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("enhancer")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("createStore"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reducer"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" preloadedState"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("em",[this._v("想更好的理解这段代码，可以参考applyMiddleware内部的实现。")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 要求传递给createStore的第一个参数必须是一个函数")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" reducer "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'function'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'Expected the reducer to be a function.'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 保存初始的reducer")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" currentReducer "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" reducer\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 保存初始的state")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" currentState "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" preloadedState\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 保存所有的事件监听器")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" currentListeners "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 获取当前监听器的一个副本(相同的引用)")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" nextListeners "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" currentListeners\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 是否正在派发action")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" isDispatching "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("ensureCanMutateNextListeners")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果nextListeners和currentListeners具有相同的引用，则获取一份当前事件监听器集合的一个副本保存到nextListeners中")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nextListeners "),n("span",{attrs:{class:"token operator"}},[s._v("===")]),s._v(" currentListeners"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    nextListeners "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" currentListeners"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("slice")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("上面就是"),t("code",[this._v("createStore")]),this._v("方法中的一些初始参数，这里有一个地方值得思考："),t("strong",[this._v("为什么要维护两份事件监听器列表(nextListeners,currentListeners)?")]),this._v("。下面，我们会解释。")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 直接返回当前store的state")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("getState")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" currentState\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[s._v("  "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("subscribe")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("listener"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 事件监听器必须是函数，否则会抛出异常")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" listener "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'function'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'Expected listener to be a function.'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 这个事件监听器是否已经被取消的标志(个人感觉：这个初始值应该被设置为false，语意化更好一些。)")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" isSubscribed "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 调用这个函数的结果就是生成一份当前事件监听器的一个副本保存到nextListeners中")]),s._v("\n    "),n("span",{attrs:{class:"token function"}},[s._v("ensureCanMutateNextListeners")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 将新的事件监听器添加到nextListeners中")]),s._v("\n    nextListeners"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("push")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("listener"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 返回一个取消监听的函数")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("unsubscribe")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果这个监听器已经被取消了，则直接return")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("isSubscribed"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 将监听器是否取消的标志设置为false")]),s._v("\n      isSubscribed "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 再次生成一份事件监听器集合的副本")]),s._v("\n      "),n("span",{attrs:{class:"token function"}},[s._v("ensureCanMutateNextListeners")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 获取到需要取消的事件监听器的索引")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" index "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" nextListeners"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("indexOf")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("listener"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 从事件监听器集合中删除这个事件监听器")]),s._v("\n      nextListeners"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("splice")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("index"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("1")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("p",[s._v("从"),n("code",[s._v("subscribe")]),s._v("方法的源码中可以看出，每次在进行监听器的"),n("code",[s._v("添加/删除")]),s._v("之前，都会基于当前的监听器集合生成一个副本保存到"),n("code",[s._v("nextListeners")]),s._v("中。这个时候还是不能准确的回答上面的问题，下面我们继续研究"),n("code",[s._v("dispatch")]),s._v("的源码:")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("dispatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// dispatch的参数就是我们需要派发的action，一定要保证这个action是一个纯粹的对象")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果不是一个纯粹的对象，则会抛出异常。")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token operator"}},[s._v("!")]),n("span",{attrs:{class:"token function"}},[s._v("isPlainObject")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 这个方法有坑，在低版本的IE浏览器中性能很差，最后我们会研究这个方法的源码。")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        "),n("span",{attrs:{class:"token string"}},[s._v("'Actions must be plain objects. '")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v("\n        "),n("span",{attrs:{class:"token string"}},[s._v("'Use custom middleware for async actions.'")]),s._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 所派发的action必须有一个type属性(我们可以将这个属性认为就是action的身份证，这样redux才知道你派发的是哪个action，你需要做什么，该怎么为你做)")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果没有这个属性则会抛出异常")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" action"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type "),n("span",{attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        "),n("span",{attrs:{class:"token string"}},[s._v("'Actions may not have an undefined \"type\" property. '")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v("\n        "),n("span",{attrs:{class:"token string"}},[s._v("'Have you misspelled a constant?'")]),s._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果redux正在派发action，则抛出异常？什么时候会出现这种情况？？？")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("isDispatching"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'Reducers may not dispatch actions.'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      isDispatching "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 派发action")]),s._v("\n      "),n("span",{attrs:{class:"token comment"}},[s._v("// 实质就是将当前的state和你需要派发的action传递给reducer函数病返回一个新的state")]),s._v("\n      currentState "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("currentReducer")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("currentState"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" action"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      isDispatching "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 这一块也是一个十分关键的地方，哈哈哈哈哈，又多了一份事件监听器的列表，简单的说一下这三份列表的作用")]),s._v("\n  \t"),n("span",{attrs:{class:"token comment"}},[s._v("// nextListeners: 保存这次dispatch后，需要触发的所有事件监听器的列表")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// currentListeners: 保存一份nextListeners列表的副本")]),s._v("\n  \t"),n("span",{attrs:{class:"token comment"}},[s._v("// listeners: 需要执行的列表")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" listeners "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" currentListeners "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" nextListeners\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" i "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("0")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v(" listeners"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{attrs:{class:"token operator"}},[s._v("++")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" listener "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" listeners"),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t  "),n("span",{attrs:{class:"token comment"}},[s._v("// 调用所有的事件监听器")]),s._v("\n      "),n("span",{attrs:{class:"token function"}},[s._v("listener")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{attrs:{class:"token comment"}},[s._v("//  dispatch的返回值也是十分重要的，如果没有这个返回值，就不可能引入强大的中间件机制。")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" action\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("到这里，我们就可以回答这个问题了："),t("strong",[this._v("为什么要维护两份事件监听器列表(nextListeners,currentListeners)?")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("img",{attrs:{src:"/blog/redux3.png",alt:"redux"}})])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("p",[s._v("这个图表示，当"),n("code",[s._v("dispatch")]),s._v("方法执行到这行代码的时候，"),n("code",[s._v("listeners")]),s._v("，"),n("code",[s._v("currentListeners")]),s._v("，"),n("code",[s._v("nextListeners")]),s._v("这三个变量引用内存中的同一份数组，只要其中一个发生变化，另外两个立马改变。和下面的这个例子一样的含义：")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("img",{attrs:{src:"/blog/redux5.png",alt:"redux"}})])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("所以，在这种情况下。"),t("strong",[this._v("如果我在某个事件监听器函数中调用了取消了某个监听器，那么在这次dispatch后，被取消的这个事件监听器就不会被执行了（？？？？？是吗？？？？）。")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("createStore"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" combineReducers"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" applyMiddleware"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'../src'")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logger "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'redux-logger'")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" actionTypes "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'@@redux/INIT'")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{attrs:{class:"token function-variable function"}},[s._v("reducers")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" action"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("switch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("case")]),s._v(" actionTypes"),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token string"}},[s._v("'type'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" actionTypes\n      "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("default")]),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" state\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" store "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("createStore")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reducers"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("applyMiddleware")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" listener1 "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" store"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("subscribe")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'listener1'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" listener2 "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" store"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("subscribe")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 取消listener3")]),s._v("\n    "),n("span",{attrs:{class:"token function"}},[s._v("listener3")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    console"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'listener2'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" listener3 "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" store"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("subscribe")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("log")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'listener3'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nstore"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("dispatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("type"),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" actionTypes"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[this._v("listener1\nlistener2\nlistener3\n")])]),this._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[this._v("1")]),t("br"),t("span",{staticClass:"line-number"},[this._v("2")]),t("br"),t("span",{staticClass:"line-number"},[this._v("3")]),t("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("结果，就是："),t("strong",[this._v("即使你在某个事件监听器中，取消了其它的事件监听器，那么被取消的这个事件监听器，在这次dispatch后仍然会执行")]),this._v("。也就是说。"),t("strong",[this._v("redux会保证在某个dispatch后，会保证在这个dispatch之前的所有事件监听器全部执行。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("这是个bug还是个feature。无从而知，但是从redux源码中，可以知道，这是一个bug。所以，redux作者就利用上面的方法很巧妙的避免了这种情况。其实实现的方法很简单："),t("strong",[this._v("切断nextListeners和currentListener,listeners相同的引用关系")]),this._v("。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("img",{attrs:{src:"/blog/redux4.png",alt:"redux"}})])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 提换reducer的方法。(动态加载reducers的时候才用)")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("replaceReducer")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nextReducer"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" nextReducer "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'function'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v("'Expected the nextReducer to be a function.'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    currentReducer "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" nextReducer\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 替换结束后，重新初始化")]),s._v("\n    "),n("span",{attrs:{class:"token function"}},[s._v("dispatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" type"),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ActionTypes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token constant"}},[s._v("INIT")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 触发预设action，主要就是为了生成初始的state tree的结构")]),s._v("\n"),n("span",{attrs:{class:"token function"}},[s._v("dispatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" type"),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ActionTypes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token constant"}},[s._v("INIT")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 这就很熟悉了吧")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    dispatch"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    subscribe"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    getState"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    replaceReducer"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  \t"),n("span",{attrs:{class:"token comment"}},[s._v("// 尼玛 忽略这个")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("$$observable"),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" observable\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])])}],!1,null,null,null);e.options.__file="redux源码解读－－createStore源码解析.md";t.default=e.exports}}]);