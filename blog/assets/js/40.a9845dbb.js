(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{190:function(s,a,t){"use strict";t.r(a);var n=t(0),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("div",{staticClass:"content"},[t("h1",[s._v("Nginx学习-常见问题")]),s._v(" "),t("h2",{attrs:{id:"多个虚拟主机优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#多个虚拟主机优先级","aria-hidden":"true"}},[s._v("#")]),s._v(" 多个虚拟主机优先级")]),s._v(" "),t("p",[t("strong",[s._v("配置一：")])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" testserver1 test"),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("saisai"),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[t("strong",[s._v("配置二：")])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" testserver2 test"),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("saisai"),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("上述两份"),t("code",[s._v("nginx")]),s._v("的配置中都包含了"),t("code",[s._v("test.saisai.com")]),s._v("。这两份的配置其实是会产生冲突，即使有冲突的存在，也不会影响"),t("code",[s._v("nginx")]),s._v("的正常启动。这里就会出现一个问题 - "),t("strong",[s._v("在多个虚拟主机中有同样的server_name，nginx是怎么处理的？")])]),s._v(" "),t("p",[s._v("下面是三份"),t("code",[s._v("nginx")]),s._v("的配置文件，这里我直接对"),t("code",[s._v("server_name")]),s._v("\b进行相同ip的配置。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("test_server1.conf")])])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" testserver1 "),t("span",{attrs:{class:"token number"}},[s._v("192.168")]),t("span",{attrs:{class:"token number"}},[s._v(".144")]),t("span",{attrs:{class:"token number"}},[s._v(".129")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("opt"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code1"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("htm"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("test_server2.conf")])])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" testserver2 "),t("span",{attrs:{class:"token number"}},[s._v("192.168")]),t("span",{attrs:{class:"token number"}},[s._v(".144")]),t("span",{attrs:{class:"token number"}},[s._v(".129")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("opt"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code2"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("htm"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("test_server3.conf")])])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" testserver3 "),t("span",{attrs:{class:"token number"}},[s._v("192.168")]),t("span",{attrs:{class:"token number"}},[s._v(".144")]),t("span",{attrs:{class:"token number"}},[s._v(".129")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("opt"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code3"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("htm"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("下面是配置文件不同之处")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{attrs:{class:"token function"}},[s._v("diff")]),s._v(" test_server1.conf test_server2.conf\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 3c3")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# < \tserver_name testserver1 192.168.144.129;")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# ---")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# > \tserver_name testserver2 192.168.144.129;")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 6c6")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# < \t\troot /opt/app/code1;")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# ---")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# > \t\troot /opt/app/code2;")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("除了"),t("code",[s._v("server_name")]),s._v("的配置不同，"),t("code",[s._v("location.root")]),s._v("也是不一样的，主要是为了方便查看请求\b返回的是什么资源。")]),s._v(" "),t("p",[s._v("然后检测一下我们的"),t("code",[s._v("nginx")]),s._v("的配置是否正确")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("nginx -tc /etc/nginx/nginx.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("会看到如下输出")]),s._v(" "),t("div",{staticClass:"language-txt line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('nginx: [warn] conflicting server name "192.168.144.129" on 0.0.0.0:80, ignored\nnginx: [warn] conflicting server name "192.168.144.129" on 0.0.0.0:80, ignored\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("有warning输出，表示服务名称有冲突，但是其它语法OK。warning是不会影响"),t("code",[s._v("nginx")]),s._v("运行的，下面执行"),t("code",[s._v("reload")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("nginx -s reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后在浏览器中输入"),t("code",[s._v("http://192.168.144.129")]),s._v("访问页面，会发现，"),t("strong",[s._v("始终返回的是"),t("code",[s._v("server1")]),s._v("配置中的页面。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/blog/server1.png",alt:""}})]),s._v(" "),t("p",[s._v("\b也就是"),t("code",[s._v("test_server1.conf")]),s._v("配置生效了。下面呢，把"),t("code",[s._v("test_server1.conf")]),s._v("重命名为"),t("code",[s._v("test_server4.conf")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{attrs:{class:"token function"}},[s._v("mv")]),s._v(" test_server1.conf test_server4.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("重启"),t("code",[s._v("nginx")]),s._v("，然后访问"),t("code",[s._v("http://192.168.144.129")]),s._v("。会返现访问到"),t("code",[s._v("server2")]),s._v("中的页面")]),s._v(" "),t("p",[t("img",{attrs:{src:"/blog/server2.png",alt:""}})]),s._v(" "),t("p",[s._v("在服务器上执行如下命令")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{attrs:{class:"token function"}},[s._v("ls")]),s._v(" test_server*\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"/blog/ls-test_server.png",alt:""}})]),s._v(" "),t("p",[s._v("\b所以，这里可以得出一个初步的结论："),t("strong",[s._v("对于相同server_name多个虚拟主机的访问，nginx读取文件名的顺序会按照文件在系统中优先读取的顺序。")])]),s._v(" "),t("h2",{attrs:{id:"location匹配优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#location匹配优先级","aria-hidden":"true"}},[s._v("#")]),s._v(" location匹配优先级")]),s._v(" "),t("p",[s._v("\b"),t("code",[s._v("location")]),s._v("的配置语法如下")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" 匹配符 路径 "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("匹配符主要有如下几种：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("=")]),s._v("：进行普通字符的精确匹配，也就是完全匹配")]),s._v(" "),t("li",[t("strong",[s._v("^~")]),s._v("：表示普通字符匹配，使用前缀匹配")]),s._v(" "),t("li",[t("strong",[s._v("~/~*")]),s._v("：执行正则匹配")])]),s._v(" "),t("blockquote",[t("p",[s._v("~ \b区分大小写，~*不区分大小写")])]),s._v(" "),t("p",[s._v("下面是关于"),t("code",[s._v("location")]),s._v("的一段配置")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("192.168")]),t("span",{attrs:{class:"token number"}},[s._v(".144")]),t("span",{attrs:{class:"token number"}},[s._v(".129")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("opt"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{attrs:{class:"token comment"}},[s._v("# 精确匹配")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code1"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("rewrite")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token operator"}},[s._v("*")]),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code1"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("break")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),t("span",{attrs:{class:"token comment"}},[s._v("# 正则匹配")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code"),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("rewrite")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token operator"}},[s._v("*")]),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code3"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("break")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),t("span",{attrs:{class:"token comment"}},[s._v("# 普通字符匹配，使用前缀匹配")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("rewrite")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token operator"}},[s._v("*")]),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code2"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("break")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("访问"),t("code",[s._v("http://192.168.144.129/code1/")]),s._v("会发现返回的是"),t("code",[s._v("server1")]),s._v("的内容。")]),s._v(" "),t("p",[s._v("然后把下面一段注释")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code1"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("rewrite")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token operator"}},[s._v("*")]),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code1"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("break")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("重启，访问"),t("code",[s._v("http://192.168.144.129/code1/")]),s._v("会返回"),t("code",[s._v("server2")]),s._v("的内容。同样，把下面的内容注释")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token comment"}},[s._v("# 普通字符匹配，使用前缀匹配")]),s._v("\n"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("rewrite")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("^")]),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token operator"}},[s._v("*")]),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code2"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),t("span",{attrs:{class:"token keyword"}},[s._v("break")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("重启，访问"),t("code",[s._v("http://192.168.144.129/code1/")]),s._v("会返回"),t("code",[s._v("server3")]),s._v("的内容。")]),s._v(" "),t("p",[s._v("从上面的访问情况就能够大致推出"),t("code",[s._v("nginx")]),s._v("的location的匹配规则了："),t("code",[s._v("精确匹配 > 前缀匹配 > 正则匹配")]),s._v("。")]),s._v(" "),t("blockquote",[t("p",[s._v("前缀匹配也会有一个最长匹配原则")])]),s._v(" "),t("h2",{attrs:{id:"try-files"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#try-files","aria-hidden":"true"}},[s._v("#")]),s._v(" try_files")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("try_files")]),s._v(" "),t("span",{attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),t("span",{attrs:{class:"token variable"}},[s._v("$uri")]),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token keyword"}},[s._v("index")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("首先检查用户请求的uri的内容在本地是否存在，如果不存在，则尝试在\b请求路径结尾加一个"),t("code",[s._v("/")]),s._v("，类似于重定向处理，如果还不存在则\b交给"),t("code",[s._v("index.php")]),s._v("来处理。")]),s._v(" "),t("p",[s._v("比如下面的"),t("code",[s._v("nginx")]),s._v("规则")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("80")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("192.168")]),t("span",{attrs:{class:"token number"}},[s._v(".144")]),t("span",{attrs:{class:"token number"}},[s._v(".129")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("opt"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("code"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("cache"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("try_files")]),s._v(" "),t("span",{attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" @node_page"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" @node_page "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" "),t("span",{attrs:{class:"token keyword"}},[s._v("http")]),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token number"}},[s._v("127.0")]),t("span",{attrs:{class:"token number"}},[s._v(".0")]),t("span",{attrs:{class:"token number"}},[s._v(".1")]),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{attrs:{class:"token number"}},[s._v("9090")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("上面的配置规则会首先访问用户访问的uri对应的文件，如果不存在交给"),t("code",[s._v("http://127.0.0.1:9090")]),s._v("服务进行处理。")]),s._v(" "),t("p",[s._v("当访问"),t("code",[s._v("http://192.168.144.129/saisai.html")]),s._v("会返回"),t("code",[s._v("/opt/app/code/cache/saisai.html")]),s._v("文件的内容。访问其他路径的时候则返回"),t("code",[s._v("http://127.0.0.1:9090")]),s._v("服务处理后的结果。")]),s._v(" "),t("p",[s._v("上述配置中涉及到了"),t("code",[s._v("location")]),s._v("的"),t("code",[s._v("@name")]),s._v("的用法。")]),s._v(" "),t("p",[t("code",[s._v("@")]),s._v("是用来命名location的，主要用于"),t("code",[s._v("nginx")]),s._v("内部的重定向，不能处理外部过来的请求。其基本用法如下：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("try_files")]),s._v(" "),t("span",{attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" @someName"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" @someName "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token comment"}},[s._v("# 具体规则")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("首先尝试访问uri对应的文件，找不到对应的文件就重定向到我们自定义的命名location。")]),s._v(" "),t("blockquote",[t("p",[s._v("命名location中不能再嵌套其它的命名location")])]),s._v(" "),t("h2",{attrs:{id:"alias-和-root"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#alias-和-root","aria-hidden":"true"}},[s._v("#")]),s._v(" alias 和 root")]),s._v(" "),t("p",[t("code",[s._v("nginx")]),s._v("中的"),t("code",[s._v("root")]),s._v("指令\b指定了我们程序的根目录是在哪一个位置。")]),s._v(" "),t("p",[s._v("比如我们有如下的配置")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("request_path"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("image"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("local_path"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("image"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("当客户端访问的资源路径是"),t("code",[s._v("http://192.168.144.129/request_path/image/cat.png")]),s._v("的时候，根据"),t("code",[s._v("root")]),s._v("规则的设置，"),t("code",[s._v("nginx")]),s._v("会访问本机的资源就是"),t("code",[s._v("/local_path/image/request_path/image/cat.png")]),s._v("；也就是"),t("code",[s._v("root+uri")]),s._v("。")]),s._v(" "),t("p",[s._v("当我们使用"),t("code",[s._v("alias")]),s._v("\b来配置路径的时候")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("request_path"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("image"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{attrs:{class:"token keyword"}},[s._v("alias")]),s._v(" "),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("local_path"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("image"),t("span",{attrs:{class:"token operator"}},[s._v("/")]),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("同样访问"),t("code",[s._v("http://192.168.144.129/request_path/image/cat.png")]),s._v("的时候，根据"),t("code",[s._v("alias")]),s._v("的配置规则，nginx实际访问的资源就是"),t("code",[s._v("/local_path/image/cat.png")]),s._v("。")]),s._v(" "),t("p",[s._v("综上，"),t("strong",[s._v("如果通过"),t("code",[s._v("root")]),s._v("指令来配置文件，真实的路径是"),t("code",[s._v("root")]),s._v("指定的值加上"),t("code",[s._v("location")]),s._v("指定的值。通过"),t("code",[s._v("alias")]),s._v("来配置文件，"),t("code",[s._v("alias")]),s._v("指定的路径是"),t("code",[s._v("location")]),s._v("的别名，不管"),t("code",[s._v("location")]),s._v("的值怎么写，资源的真实路径都是"),t("code",[s._v("alias")]),s._v("指定的路径。")])]),s._v(" "),t("p",[t("strong",[s._v("注意：")])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("alias")]),s._v(" 只能作用在"),t("code",[s._v("location")]),s._v("中，而"),t("code",[s._v("root")]),s._v("可以存在"),t("code",[s._v("server")]),s._v("、"),t("code",[s._v("http")]),s._v("和"),t("code",[s._v("location")]),s._v("中。")]),s._v(" "),t("li",[t("code",[s._v("alias")]),s._v(" 后面必须要用 “/” 结束，否则会找不到文件，而 "),t("code",[s._v("root")]),s._v(" 则对 ”/” 可有可无。")])]),s._v(" "),t("h2",{attrs:{id:"x-real-ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#x-real-ip","aria-hidden":"true"}},[s._v("#")]),s._v(" X-Real-ip")]),s._v(" "),t("p",[s._v("这种场景主要出现在我们的"),t("code",[s._v("nginx")]),s._v("并不是作为\b用户的直接服务，而是作为代理而出现的。这种情况就可能会出现用户的真实地址无法获取到。这种情况的请求链路可能如下：")]),s._v(" "),t("div",{staticClass:"language-txt line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("用户(IP1)  ---\x3e\n代理1(IP2) ---\x3e\n代理2(IP3) ---\x3e\n...\n后端服务(IPn)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("在这种情况下，我们应该从一级代理出发（这里就是代理1），约定一个请求头，比如"),t("code",[s._v("x_real_ip")]),s._v("来存储用户真实的"),t("code",[s._v("ip")]),s._v("地址。然后一级一级的透传到后端服务，后端服务就能通过"),t("code",[s._v("x_real_ip")]),s._v("头部获取到用户真实的ip信息。")]),s._v(" "),t("h2",{attrs:{id:"nginx-413-request-entity-too-large"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-413-request-entity-too-large","aria-hidden":"true"}},[s._v("#")]),s._v(" Nginx: 413 Request Entity Too Large")]),s._v(" "),t("p",[s._v("Nginx会对用户上传的文件的大小进行限制，这个限制通过"),t("code",[s._v("client_max_body_size")]),s._v("来设置，可以通过这个指令来重设限制的大小。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("Syntax"),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\t"),t("span",{attrs:{class:"token keyword"}},[s._v("client_max_body_size")]),s._v(" size"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nDefault"),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\t\n"),t("span",{attrs:{class:"token keyword"}},[s._v("client_max_body_size")]),s._v(" "),t("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("m"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nContext"),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\t"),t("span",{attrs:{class:"token keyword"}},[s._v("http")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{attrs:{class:"token keyword"}},[s._v("server")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("其它错误")]),s._v(" "),t("ul",[t("li",[s._v("Nginx: 502 bad gateway：后端服务无响应。")]),s._v(" "),t("li",[s._v("Nginx：504 Gateway Time-out：后端服务执行超时")])]),s._v(" "),t("h2",{attrs:{id:"ab压测工具"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ab压测工具","aria-hidden":"true"}},[s._v("#")]),s._v(" ab压测工具")]),s._v(" "),t("p",[t("strong",[s._v("1. 安装")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("yum "),t("span",{attrs:{class:"token function"}},[s._v("install")]),s._v(" httpd-tools\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("code",[s._v("httpd-tools")]),s._v("包中包含了"),t("code",[s._v("ab")]),s._v("测试工具。")]),s._v(" "),t("p",[t("strong",[s._v("2. 基本用法")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ab -n 2000 -c 2 http://127.0.0.1\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# -n：总的请求数")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# -c：并发数目")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# -k：是否开启长连接")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("比如，对我们的服务器使用下面的命令进行压测")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ab -n 2000 -c 2 http://127.0.0.1/saisai.html\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可能会得到如下输出，下面这些输出是对本次压测结果的具体描述")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{attrs:{class:"token comment"}},[s._v("# 压测对应的服务器信息")]),s._v("\nServer Software:        nginx/1.14.2\nServer Hostname:        127.0.0.1\nServer Port:            80\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 压测的文件的路径")]),s._v("\nDocument Path:          /saisai.html\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 文件的大小")]),s._v("\nDocument Length:        7 bytes\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 并发级别，就是-c参数指定的值")]),s._v("\nConcurrency Level:      2\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# \b请求的总时间")]),s._v("\nTime taken "),t("span",{attrs:{class:"token keyword"}},[s._v("for")]),s._v(" tests:   0.188 seconds\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# \b总的请求个数")]),s._v("\nComplete requests:      2000\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 请求失败的个数")]),s._v("\nFailed requests:        0\n\nWrite errors:           0\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 总共传输的数据量，指的是ab从被测服务器接收到的总数据量，包括index.html的文本内容和请求头信息。")]),s._v("\nTotal transferred:      472236 bytes\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 从服务器接收到的index.html文件的总大小，等于Document Length＊Complete requests＝7 bytes＊2000＝14007 bytes")]),s._v("\nHTML transferred:       14007 bytes\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# rps 每秒的请求数 -- 总的请求数/请求总的时间")]),s._v("\nRequests per second:    10635.30 "),t("span",{attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{attrs:{class:"token comment"}},[s._v("#/sec] (mean)")]),s._v("\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 对于客户端而言，每个请求所需要的时间")]),s._v("\nTime per request:       0.188 "),t("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ms"),t("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mean"),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 服务端处理每个请求的平均时间 不包含客户端和服务端网络传输的时间")]),s._v("\nTime per request:       0.094 "),t("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ms"),t("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mean, across all concurrent requests"),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 传输的速率。可以用来判断网络是否有问题")]),s._v("\nTransfer rate:          2452.33 "),t("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Kbytes/sec"),t("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br")])]),t("h2",{attrs:{id:"系统与nginx的性能优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统与nginx的性能优化","aria-hidden":"true"}},[s._v("#")]),s._v(" 系统与Nginx\b的性能优化")]),s._v(" "),t("p",[t("strong",[s._v("1. 文件句柄")])]),s._v(" "),t("p",[t("code",[s._v("linux/unix")]),s._v("一切皆是文件，文件句柄就是一个索引。文件句柄也会随着请求量的增多，也会增加。系统对文件句柄是有限制的，不能让一个进程无限制的增加文件句柄。我们可以自己设置文件句柄的多少。")]),s._v(" "),t("p",[t("strong",[s._v("2. 设置方式")])]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("系统全局性修改")])])]),s._v(" "),t("p",[s._v("我们可以编辑"),t("code",[s._v("/etc/security/limits.conf")]),s._v("文件来修改文件句柄的多少。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("vim /etc/security/limits.conf\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 可以在文件的末尾添加如下格式的配置文件")]),s._v("\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 针对所有用户(全局性配置)")]),s._v("\n* soft nofile 65535\n* hard nofile 65535\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 用户 soft/hard nofile 句柄数(一般10000左右)")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# soft：只发提醒，超过限制的时候发送提醒，但不会限制")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# hard：超过限制的时候，系统会采取机制进行限制")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("用户\b局部性修改")])])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("vim \n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 文件末尾添加")]),s._v("\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 针对root用户的限制")]),s._v("\nroot soft nofile 65535\nroot hard nofile 65535\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("进程局部性修改")])])]),s._v(" "),t("p",[s._v("我们也可以根据进程进行单独的设置，比如针对"),t("code",[s._v("Nginx")]),s._v("的进程进行单独的句柄设置。")]),s._v(" "),t("p",[t("code",[s._v("nginx")]),s._v("文件句柄的设置语法")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("Syntax"),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\t"),t("span",{attrs:{class:"token keyword"}},[s._v("worker_rlimit_nofile")]),s._v(" number"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nDefault"),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\t—\nContext"),t("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\tmain\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("vim /etc/nginx/nginx.conf\n\n"),t("span",{attrs:{class:"token comment"}},[s._v("# 可以在配置文件中添加如下指令")]),s._v("\nworker_rlimit_nofile 35535"),t("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])}],!1,null,null,null);e.options.__file="Nginx学习-常见问题.md";a.default=e.exports}}]);