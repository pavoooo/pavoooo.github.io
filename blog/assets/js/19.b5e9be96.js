(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{197:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"content"},[n("h1",[s._v("Vue源码之nextTick")]),s._v(" "),s._m(0),s._v(" "),n("p",[n("code",[s._v("Vue.netTick")]),s._v("算是"),n("code",[s._v("Vue")]),s._v("中重构的比较彻底的一个方法，在"),n("code",[s._v("2.x")]),s._v("早期的版本中。这个方法的实现主要依赖的是"),n("code",[s._v("microtask")]),s._v("机制，但是在某些场景下"),n("code",[s._v("microtask")]),s._v("的优先级比较高，会造成事件触发之前数据已经更新。比如("),n("a",{attrs:{href:"https://github.com/vuejs/vue/issues/4521",target:"_blank",rel:"noopener noreferrer"}},[s._v("#4521"),n("OutboundLink")],1),s._v(", "),n("a",{attrs:{href:"https://github.com/vuejs/vue/issues/6690",target:"_blank",rel:"noopener noreferrer"}},[s._v("#6690"),n("OutboundLink")],1),s._v(", "),n("a",{attrs:{href:"https://github.com/vuejs/vue/issues/6566",target:"_blank",rel:"noopener noreferrer"}},[s._v("#6566"),n("OutboundLink")],1),s._v(")。然而，如果使用"),n("code",[s._v("macrotask")]),s._v("来实现这个方法，当状态在重绘之前改变的时候也会造成一些微妙的问题("),n("a",{attrs:{href:"https://github.com/vuejs/vue/issues/6813",target:"_blank",rel:"noopener noreferrer"}},[s._v("#6813"),n("OutboundLink")],1),s._v(")。所以，现在的"),n("code",[s._v("nextTick")]),s._v("的实现方式就是：默认使用"),n("code",[s._v("microtask")]),s._v("机制，对外暴露出一个强制使用"),n("code",[s._v("macrotask")]),s._v("机制的接口。当调用这个接口的时候，我们就会在"),n("code",[s._v("macrotask")]),s._v("队列中处理状态的变化，这种机制主要用在"),n("code",[s._v("v-on")]),s._v("的事件回调中。")]),s._v(" "),s._m(1),s._v(" "),s._m(2),s._v(" "),s._m(3),n("p",[s._v("上面就是添加任务的基本过程，下面我们来看一下任务是怎么运行的？源码如下：")]),s._v(" "),s._m(4),n("p",[s._v("上面就是执行任务的方法，最主要的就是\b不同事件循环中的任务不要彼此干扰。")]),s._v(" "),s._m(5),s._v(" "),s._m(6),s._m(7),s._v(" "),s._m(8),s._m(9),s._v(" "),s._m(10),s._v(" "),s._m(11)])},[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("p",[n("code",[s._v("Vue.nextTick")]),s._v("是"),n("code",[s._v("Vue")]),s._v("中提供的一个异步接口。这个方法的第一个参数是一个可选的回调函数，这个函数会在"),n("code",[s._v("DOM")]),s._v("更新之后被调用。如果我们在修改数据之后立即调用这个方法，就能在方法中获取更新后的"),n("code",[s._v("DOM")]),s._v("。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("code",[this._v("nextTick")]),this._v("的实现我们可以抽象成三个基本的过程：创建任务，保存任务，运行任务。在运行任务的时候，我们就需要确定使用何种机制来运行我们的任务队列。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("code",[this._v("nextTick")]),this._v("方法将一次事件循环中添加的任务都保存在一个"),t("code",[this._v("callbacks")]),this._v("变量中。源码如下：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" callbacks "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" pending "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("nextTick")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cb"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" _resolve\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 将所有添加的任务保存到callbacks\b数组中")]),s._v("\n    callbacks"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("push")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cb"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                cb"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("call")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token class-name"}},[s._v("e")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{attrs:{class:"token function"}},[s._v("handleError")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'nextTick'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_resolve"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{attrs:{class:"token function"}},[s._v("_resolve")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("   \n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果不是在执行的状态，运行任务")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("pending"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        pending "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n        "),n("span",{attrs:{class:"token comment"}},[s._v("// 决定使用\b`microtask`还是`macrotask`运行我们的任务队列")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("useMacroTask"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{attrs:{class:"token function"}},[s._v("macroTimerFunc")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{attrs:{class:"token function"}},[s._v("microTimerFunc")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果我们在调用nextTick的时候没有传递回调函数，这个方法会返回一个promise，这就是这个方法的第二种用途：")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("/*\n        Vue.nextTick().then(() => {\n            // DOM更新了\n        })\n    */")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("cb "),n("span",{attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" Promise "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Promise")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resolve"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            _resolve "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" resolve\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 这个函数其实是事件循环中任务队列的回调函数")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("flushCallbacks")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 将状态置为等待任务添加的状态")]),s._v("\n    pending "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 保存一个副本")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 这样做的原因就是，如果我们在nextTick的回调函数中调用了nextTick方法，那么这个时候添加的方法会放在下一个任务队列中执行，而不是在当前队列中执行")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" copies "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" callbacks"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("slice")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token number"}},[s._v("0")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 清空队列")]),s._v("\n    callbacks"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 执行回调函数(任务)")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" i "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("0")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v(" copies"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{attrs:{class:"token operator"}},[s._v("++")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        copies"),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("下面我们来看一下"),t("code",[this._v("nextTick")]),this._v("的核心的部分，就是使用什么样的\b机制来执行我们的任务。源码如下：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 保存宏任务的回调")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" macroTimerFunc\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 保存微任务的回调")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" microTimerFunc\n\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 如果原生支持setImmediate方法，直接通过这个方法将我们的任务队列添加到事件循环的`macrotask queue`中")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 这个方法只有IE浏览器支持")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" setImmediate "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("isNative")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("setImmediate"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token function-variable function"}},[s._v("macroTimerFunc")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token function"}},[s._v("setImmediate")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flushCallbacks"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" MessageChannel "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),n("span",{attrs:{class:"token function"}},[s._v("isNative")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("MessageChannel"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("||")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("// PhantomJS")]),s._v("\n  MessageChannel"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("toString")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'[object MessageChannelConstructor]'")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果不支持`setImmediate` 方法，降级到`MessageChannel`方法，将我们的任务队列添加到`macrotask queue`中执行")]),s._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 关于这个方法的介绍可以参考[记录：window.MessageChannel那些事](https://zhuanlan.zhihu.com/p/37589777)")]),s._v("\n\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" channel "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("MessageChannel")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" port "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" channel"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("port2\n  channel"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("port1"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("onmessage "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" flushCallbacks\n  "),n("span",{attrs:{class:"token function-variable function"}},[s._v("macroTimerFunc")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    port"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("postMessage")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token number"}},[s._v("1")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("/* istanbul ignore next */")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("//  最后就直接降级为setTimeout，将我们的任务队列添加到`macrotask queue`中执行")]),s._v("\n  "),n("span",{attrs:{class:"token function-variable function"}},[s._v("macroTimerFunc")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flushCallbacks"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("0")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 下面是用来判断\b用何种方法将我们的任务队列添加到事件循环的`microtask`事件队列中")]),s._v("\n\n"),n("span",{attrs:{class:"token comment"}},[s._v("// Promise可以将我们的回调添加到事件\b循环的微任务队列中")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" Promise "),n("span",{attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v("'undefined'")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("isNative")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Promise"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" p "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" Promise"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("resolve")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token function-variable function"}},[s._v("microTimerFunc")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    p"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("then")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flushCallbacks"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v("// 这个是一个hack的手段")]),s._v("\n    "),n("span",{attrs:{class:"token comment"}},[s._v('// 因为在IOS的webview中，Promise.then的回调函数会被推入到`microtask`的任务队列，但是队列却不会被刷新。知道浏览器做其他工作的时候才会刷新这个队列，所以，我们可以通过添加一个空的定时器来"强制"微任务队列被刷新')]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("isIOS"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("noop"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{attrs:{class:"token comment"}},[s._v("// 如果不支持Promise的话，就抛弃`microtask`，直接降级到`macrotask`")]),s._v("\n  microTimerFunc "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" macroTimerFunc\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("上面就是判断运行任务的机制。\b最开始我们也提到，"),t("code",[this._v("nextTick")]),this._v("暴露了一个强制使用"),t("code",[this._v("macrotask")]),this._v("的\b一个方法，下面就是这个方法的具体实现：")])},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[s._v("// 是否使用`macrotask` 的标志")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("let")]),s._v(" useMacroTask "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("withMacroTask")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fn"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" fn"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_withTask "),n("span",{attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fn"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function-variable function"}},[s._v("_withTask")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        useMacroTask "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("const")]),s._v(" res "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" fn"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("apply")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("null")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" arguments"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        useMacroTask "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("那这个方法怎么使用的呢，我们可以在编辑器中全局搜索一下这个方法，发现只在"),t("code",[this._v("event.js")]),this._v("的"),t("code",[this._v("add")]),this._v("方法中使用。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("即使我们没有分析过这段代码，我们也能猜出来它是干嘛的，用来绑定事件的。所以，我们在"),t("code",[this._v("Vue")]),this._v("中的绑定的原生事件的回调函数所造成的状态的变化，都会被强制的在"),t("code",[this._v("macrotask")]),this._v("队列中被执行。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("关于"),t("code",[this._v("Event loop")]),this._v("的知识比较绕，笔者也没有理解的很透彻，上面也是我根据自己掌握的东西的一点理解。欢迎理解十分透彻的大神们讲述。")])])}],!1,null,null,null);e.options.__file="Vue源码之nextTick.md";t.default=e.exports}}]);