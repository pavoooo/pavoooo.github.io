# iptables学习

## 概述

`iptables`的全称是`netfilter/iptables`，是`ip`信息包过滤系统，由`netfilter`和`iptables`两部分组成。

`netfilter`组件也称为内核空间`kernelspace`，它是内核的一部分，由一些信息包过滤表组成，这些表包含内核用来控制信息包过滤处理的规则集。

`iptables`其实是一种工具，也称为用户控件`userspace`，它使插入、修改和删除信息包过滤表中的规则变得容易。

`netfilter/iptables`也简称为`iptables`。`iptables`是基于内核的防火墙，功能很强大。`iptables`中内置了`filter`，`nat`，`mangle`三张表。三张表的任一处变更都会立即生效，不需要重启。

- `filter`表：负责过滤数据包，包括的规则链有`INPUT`，`OUTPUT`和`FORWARD`。

- `nat`表：涉及到网络地址转换，包括的规则链有`PREROUTING`，`POSTROUTING`和`OUTPUT`。

- `mangle`表：主要用在修改数据包内容上，用来给数据包打个标识，默认的规则链有`INPUT`，`OUTPUT`，`FORWARD`和`PREROUTING`，`POSTROUTING`。

`iptables`涉及**三表**和**五链**，三表就是上面提到的，五链如下：

- `INPUT`：匹配流入到本机的数据包，也就是目标`ip`地址是本机
- `OUTPUT`：匹配从本机流出的数据包，一般不需要作配置
- `FORWARD`：匹配从本机进行转发的数据包，目标`ip`地址不是本机。
- `PREROUTING`：用来修改目的地址，用来做`DNAT`。比如可以把内网中的`80`端口，映射到路由器外网端口上。
- `POSTROUTING`：用来修改源地址，做`SNAT`。比如内网通过路由器`NAT`转换功能实现内网机器通过一个公网`IP`地址上网。

> 表 -> 链 -> 规则

**iptable过滤封包流程**

![]('/blog/iptables1.png')

数据包可以分为两类：

- 发给防火墙本身的数据包*(数据包流向用红色线表示)*
- 需要经过防火墙转发的数据包*(数据包流向用蓝色线表示)*

`iptables`中的三个表是有优先顺序的，一般顺序优先规则如下

`raw > mangle > nat > filter`

规则链间的匹配顺序

- 入站数据：`PREROUTING`, `INPUT`
- 出站数据：`OUTPUT`, `POSTROUTING`
- 转发数据：`PREROUTING`, `FORWARD`, `POSTROUTING`

链内的匹配顺序

- 自上而下按照顺序依次进行检查，找到相匹配的规则即停止
- 如果在链内找不到相匹配的规则，则按照该链的默认策略处理（未修改的情况下，默认策略是允许）

## iptables

查看本机是否安装了防火墙`iptables`

```bash
rpm -qf `which iptables`
```

`iptables`的配置文件一般保存在

```bash
/etc/sysconfig/iptables
```

配置文件的内容可能如下

```bash
# Generated by iptables-save v1.4.7 on Sat Jul 21 09:26:53 2018
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [5:1020]
-A INPUT -p tcp -m tcp --dport 8080 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 8080 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Sat Jul 21 09:26:53 2018
```

`iptables`启动和重启

```bash
/etc/init.d/iptables start
/etc/init.d/iptables restart
```

检查开机是否启动了

```bash
chkconfig --list iptables

# iptables       	0:关闭	1:关闭	2:关闭	3:关闭	4:关闭	5:关闭	6:关闭
```

`iptables`命令的语法格式

```bash
iptables [-t 表名] 管理选项 [链名(规则名)] [条件匹配] [-j 目标动作或者跳转]
```

- 不指定表名的时候，默认是`filter`表
- 不指定链名的时候，默认是该表内的所有链
- 除非设置规则链的缺省策略，否则需要指定匹配条件

![](/blog/iptables2.png)

### iptables命令使用

`iptables`的基本使用方法如下

```bash
iptables [-t 要操作的表]
  <操作命令>
  [要操作的链]
  [规则号码]
  [匹配条件]
  [-j 匹配到以后的动作]
```

**操作命令**

- `-A <链名>`：`APPEND`，追加一条规则，放到最后。

比如，在`filter`表的`INPUT`链里追加一条规则（作为最后一条规则），匹配所有访问本机`IP`的数据包，匹配到就丢弃

```bash
# 这个规则就是拒绝所有人访问服务器
iptables -t filter -A INPUT -j DROP

# -j DROP 表示丢弃包
```

- `-D <链名><规则名称|具体规则内容>`：`DELETE`，删除一条规则

```bash
# 删除 filter表中的INPUT 链对应的弟一条规则
iptables -D INPUT 1
```

```bash
# 删除filter表中 INPUT链中内容为"-s 192.168.144.129 -j DROP"的规则
iptables -t filter -D INPUT -s 192.168.144.129 -j DROP
```

删除规则的时候有一些注意事项

1. 如果规则列表中有多条相同的规则，按内容匹配删除序号最小的一条
2. 按照号码匹配删除的时候，确保规则号码 <= 已有规则数，否则报错
3. 按照内容匹配删除的时候，确保规则存在，否则报错

- `-P <链名> <动作>`：`POLICY`，设置某个链的默认规则

```bash
iptables -L # 查看默认规则

# 设置默认规则为DROP
iptables -t filter -P INPUT DROP
```

`-F <链名>`：`FLUSH`，清空规则

```bash
# 清空INPUT链的规则
iptables -t filter -F INPUT

# 清除filter表中所有链上的规则
iptables -F

# 清除nat表中链上所有的规则
iptables -t NAT -F
```

**注意**

1. `-F`仅仅是清空链中的规则，并不影响`-P`设置的默认规则
2. `-P` 设置了`DROP`后，使用`-F`一定要小心
3. 如果不写链名称，则清空所有链上的规则。

- `-[xvf]L <链名>`: `LIST`列出所有的规则

```bash
# 列出所有链的规则
iptables -L

# 列出INPUT链的所有规则
iptables -L INPUT
```

- `v`：显示详细信息
- `x`：在`v`的基础上，禁止自动单位换算
- `n`：只显示`IP`地址和端口号码，不显示域名和服务名称

**匹配条件**

1. 流入、流出的接口（`-i`，`-o`）

- `-i <匹配数据进入的网络接口>`：这个参数主要用于`nat`表，比如目标地址转换

```bash
# 匹配是否从网络接口 eth0进来的数据包
-i eth0
# 匹配是否从网络接口 eth0流出的数据包
-o eth0

# 匹配是否从网络接口 ppp0进来的数据包
-i ppp0
```

2. 来源、目的地址（`-s`, `-d`）

- `-s <匹配来源地址>`：可以是ip, net, domain，也可以为空（表示全部）

```bash
# 匹配来自192.168.0.1的数据包
-s 192.168.0.1

# 匹配来自于192.168.0.1/24网段的数据包
-s 192.168.0.1/24

# 匹配即将去往192.168.22.214的数据包
-d 192.168.22.214
````

3. 协议类型（`-p`）

- `-p <协议类型>`：可以是tcp，udp，icmp等，也可以为空

```bash
# 匹配tcp相关的数据包
-p tcp
# 匹配udp相关的协议
-p udp
```

4. 来源、目的端口（`--sport`, `--dport`）

- `--sport <匹配源端口>`：可以是个别端口，也可以是端口范围

```bash
# 匹配目标端口是 80 的数据包
--dport 80 
```

- `--dport <匹配目的端口>`：可以是个别端口，也可以是端口范围

```bash
# 匹配源端口是1000的数据包
--sport 1000 

# 匹配源端口是1000-3000的数据包
--sport 1000:3000

# 匹配源端口在3000以下的数据包
--sport :3000

# 匹配源端口是1000以上的数据包
--sport 1000:
```

> --sport 和 --dport必须和-p一起使用

比如

```bash
# 匹配网络中目的端口是53的udp协议数据包
-p udp --dport 53

# 匹配来自 192.168.0.1 访问 www.zhaosaisai.com:80的数据包
-s 192.168.0.1 -d www.zhaosaisai.com -p tcp --dport 80
```

**动作（处理方式）**

- `ACCEPT`：接收数据包
- `DROP`：直接将数据包丢弃（不给对方任何回应）
- `REJECT`：拒绝数据包（拒绝后，给对端一个回应）
- `SNAT`：源地址转换

```bash
-j SNAT --to IP[-IP][:端口-端口](nat 表上的POSTROUTING)

源地址转换，SNAT支持转换到单IP地址，也支持转换到一组IP地址
```

- `DNAT`：端口映射

```bash
-j DNAT --to IP[-IP][:端口-端口](nat 表上的PREROUTING)

目标地址转换，DNAT支持转换到单IP地址，也支持转换到一组IP地址
```

- `MASQUERADE`：伪装一个公网`ip`地址

下面是这些处理方式的使用方式

```bash
# 接受，允许数据包通过本链访问而不拦截它
-j ACCEPT

# 从INPUT进来的数据包都是接受的
# 也就是允许任何人访问
iptables -A INPUT -j ACCEPT

# 阻止转发 是 192.168.20.39 的数据包访问本机
iptables -A FORWARD -s 192.168.20.39 -j DROP

# 将内网192.168.22.214的原地址转换为公网ip 1.1.1.1 用于NAT
iptables -t nat -A POSTROUTING -s 192.168.22.214 -j SNAT --to 1.1.1.1

# 把从etch0进来的数据包目的地址改为192.168.22.214
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 192.168.22.214
```

## 实例

**1. 使用iptables防火墙保护web服务器**

```bash
# 首先对网路lo进行配置
iptables -A INPUT -i lo -j ACCEPT
# 打开22和80端口（一次打开多个）
# iptables -A INPUT -p tcp -m multiport --dport 22,80 -j ACCEPT

# 打开22和80端口（分多次打开）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
# 对衍生的和已经建立的连接放行
iptables -A INPUT -m state -state RELATED,ESTABLISHED -j ACCEPT

# 其它的数据默认都drop
iptables -P INPUT DROP
```

**2. 拒绝访问服务器本身和拒绝通过服务器访问别的机器**

```bash
# 拒绝一个ip地址的访问
iptables -A INPUT -s 192.168.2.1 -j DROP
# 防止通过本机转发
iptables -A FORWARD -s 192.168.2.1 -j DROP
# 禁止这个机器上网
iptables -A OUTPUT -s 192.168.2.1 -j DROP
```