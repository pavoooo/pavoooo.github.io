<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>探探Koa之resquest | 赛赛的空间</title>
    <meta name="description" content="赵赛赛个人博客，关注前端技术，后端技术，喜欢编程。每天进步一点点就好啦！">
    <link rel="icon" type="image/x-icon" href="/blog/favicon.ico">
  <script type="text/javascript" src="/blog/bdtj.js"></script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.626dd732.css" as="style"><link rel="preload" href="/blog/assets/js/app.d624a2fd.js" as="script"><link rel="preload" href="/blog/assets/js/54.ae9432b6.js" as="script"><link rel="prefetch" href="/blog/assets/js/42.d8803e7a.js"><link rel="prefetch" href="/blog/assets/js/2.285762ea.js"><link rel="prefetch" href="/blog/assets/js/3.baec0bba.js"><link rel="prefetch" href="/blog/assets/js/4.83d5b994.js"><link rel="prefetch" href="/blog/assets/js/5.3b8725d1.js"><link rel="prefetch" href="/blog/assets/js/6.6d9cba74.js"><link rel="prefetch" href="/blog/assets/js/7.11844937.js"><link rel="prefetch" href="/blog/assets/js/8.9b303ab2.js"><link rel="prefetch" href="/blog/assets/js/9.946e0c56.js"><link rel="prefetch" href="/blog/assets/js/10.8ecd39e7.js"><link rel="prefetch" href="/blog/assets/js/11.0e8bf68a.js"><link rel="prefetch" href="/blog/assets/js/12.f8fb4bc6.js"><link rel="prefetch" href="/blog/assets/js/13.96c27892.js"><link rel="prefetch" href="/blog/assets/js/14.cd787798.js"><link rel="prefetch" href="/blog/assets/js/15.9ae27a0a.js"><link rel="prefetch" href="/blog/assets/js/16.78ab6854.js"><link rel="prefetch" href="/blog/assets/js/17.ab7face3.js"><link rel="prefetch" href="/blog/assets/js/18.b5b32102.js"><link rel="prefetch" href="/blog/assets/js/19.cde47560.js"><link rel="prefetch" href="/blog/assets/js/20.792455de.js"><link rel="prefetch" href="/blog/assets/js/21.4991db05.js"><link rel="prefetch" href="/blog/assets/js/22.48b5a316.js"><link rel="prefetch" href="/blog/assets/js/23.4b7b27b4.js"><link rel="prefetch" href="/blog/assets/js/24.c88da2e6.js"><link rel="prefetch" href="/blog/assets/js/25.c96f2303.js"><link rel="prefetch" href="/blog/assets/js/26.1d26773f.js"><link rel="prefetch" href="/blog/assets/js/27.26e0a740.js"><link rel="prefetch" href="/blog/assets/js/28.c8595bdb.js"><link rel="prefetch" href="/blog/assets/js/29.4aedb1a0.js"><link rel="prefetch" href="/blog/assets/js/30.750f39d6.js"><link rel="prefetch" href="/blog/assets/js/31.25a5ef33.js"><link rel="prefetch" href="/blog/assets/js/32.73d3ea30.js"><link rel="prefetch" href="/blog/assets/js/33.408502f5.js"><link rel="prefetch" href="/blog/assets/js/34.ac55d7c2.js"><link rel="prefetch" href="/blog/assets/js/35.381a01b1.js"><link rel="prefetch" href="/blog/assets/js/36.84491f5d.js"><link rel="prefetch" href="/blog/assets/js/37.55b769f6.js"><link rel="prefetch" href="/blog/assets/js/38.744e0e13.js"><link rel="prefetch" href="/blog/assets/js/39.d582abd0.js"><link rel="prefetch" href="/blog/assets/js/40.7fbd8240.js"><link rel="prefetch" href="/blog/assets/js/41.9622f7ca.js"><link rel="prefetch" href="/blog/assets/js/43.897a1954.js"><link rel="prefetch" href="/blog/assets/js/44.3bd37b9a.js"><link rel="prefetch" href="/blog/assets/js/45.44186f08.js"><link rel="prefetch" href="/blog/assets/js/46.d3a5a4ba.js"><link rel="prefetch" href="/blog/assets/js/47.d5d9ce11.js"><link rel="prefetch" href="/blog/assets/js/48.532ec14d.js"><link rel="prefetch" href="/blog/assets/js/49.f6028240.js"><link rel="prefetch" href="/blog/assets/js/50.8270bebc.js"><link rel="prefetch" href="/blog/assets/js/51.f5e3b518.js"><link rel="prefetch" href="/blog/assets/js/52.7d8f5443.js"><link rel="prefetch" href="/blog/assets/js/53.32b1febf.js"><link rel="prefetch" href="/blog/assets/js/55.23807bf9.js"><link rel="prefetch" href="/blog/assets/js/56.83bc381a.js"><link rel="prefetch" href="/blog/assets/js/57.edc17c29.js"><link rel="prefetch" href="/blog/assets/js/58.45e37e07.js"><link rel="prefetch" href="/blog/assets/js/59.6a38e90b.js"><link rel="prefetch" href="/blog/assets/js/60.efa844cb.js"><link rel="prefetch" href="/blog/assets/js/61.101cbe96.js"><link rel="prefetch" href="/blog/assets/js/62.15bce085.js"><link rel="prefetch" href="/blog/assets/js/63.99b2e3cc.js"><link rel="prefetch" href="/blog/assets/js/64.e921aa27.js"><link rel="prefetch" href="/blog/assets/js/65.d6c2ecba.js"><link rel="prefetch" href="/blog/assets/js/66.b3927896.js"><link rel="prefetch" href="/blog/assets/js/67.7fe447a3.js"><link rel="prefetch" href="/blog/assets/js/68.bf483d3f.js"><link rel="prefetch" href="/blog/assets/js/69.2f49f9d6.js"><link rel="prefetch" href="/blog/assets/js/70.0dd98461.js"><link rel="prefetch" href="/blog/assets/js/71.2a26d92a.js"><link rel="prefetch" href="/blog/assets/js/72.3964d21e.js"><link rel="prefetch" href="/blog/assets/js/73.1700c879.js"><link rel="prefetch" href="/blog/assets/js/74.7d05986e.js"><link rel="prefetch" href="/blog/assets/js/75.20664c69.js"><link rel="prefetch" href="/blog/assets/js/76.4c09efcb.js"><link rel="prefetch" href="/blog/assets/js/77.475345fa.js"><link rel="prefetch" href="/blog/assets/js/78.14a7e3f7.js"><link rel="prefetch" href="/blog/assets/js/79.39d49e82.js"><link rel="prefetch" href="/blog/assets/js/80.3296f990.js"><link rel="prefetch" href="/blog/assets/js/81.6450c0c4.js"><link rel="prefetch" href="/blog/assets/js/82.62728394.js"><link rel="prefetch" href="/blog/assets/js/83.8400b675.js"><link rel="prefetch" href="/blog/assets/js/84.44ae1088.js"><link rel="prefetch" href="/blog/assets/js/85.a5423029.js"><link rel="prefetch" href="/blog/assets/js/86.3b5be10e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.626dd732.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link"><img src="/blog/logo.png" alt="赛赛的空间" class="logo"> <span class="site-name can-hide">赛赛的空间</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/translate.html" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/translate.html" class="nav-link">翻译</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1>探探Koa之resquest</h1> <p><code>Koa</code>中<code>request</code>模块是对原生<code>http</code>请求<code>req</code>对象的包装和增强。下面会按照先前梳理的顺序为大家一一介绍各个属性和方法的具体实现细节。</p> <p><img src="https://zhaosaisai.com/blog/request.svg" alt="request"></p> <h2 id="属性"><a href="#属性" aria-hidden="true" class="header-anchor">#</a> 属性</h2> <h3 id="headers和header"><a href="#headers和header" aria-hidden="true" class="header-anchor">#</a> headers和header</h3> <p><code>request</code>对象的<code>headers</code>和<code>header</code>属性是用来获取和设置请求头的。其中<code>request.headers</code>是<code>request.header</code>的别名。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>headers
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">header</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>headers <span class="token operator">=</span> val
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="method"><a href="#method" aria-hidden="true" class="header-anchor">#</a> method</h3> <p><code>request.method</code>用来获取或设置请求方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>method<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">method</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>method <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="url"><a href="#url" aria-hidden="true" class="header-anchor">#</a> url</h3> <p><code>request.url</code>用来获取或设置请求<code>url</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">url</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>url <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="path"><a href="#path" aria-hidden="true" class="header-anchor">#</a> path</h3> <p><code>request.path</code>用来获取或设置请求路径</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">path</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> path<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  url<span class="token punctuation">.</span>pathname <span class="token operator">=</span> path<span class="token punctuation">;</span>
  url<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token function">stringify</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>设置<code>path</code>的时候会保留原来的查询字符串等数据，同时也会对<code>url</code>进行更新。</p></blockquote> <h3 id="query"><a href="#query" aria-hidden="true" class="header-anchor">#</a> query</h3> <p><code>request.query</code>用来获取或设置请求的查询字符串对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>querystring<span class="token punctuation">;</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_querycache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_querycache <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 会把query进行缓存</span>
  <span class="token keyword">return</span> c<span class="token punctuation">[</span>str<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c<span class="token punctuation">[</span>str<span class="token punctuation">]</span> <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">query</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>querystring <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>设置<code>request.query</code>本质上改变的是查询字符串，所以会重置<code>request.querystring</code>属性。</p></blockquote> <h3 id="querystring"><a href="#querystring" aria-hidden="true" class="header-anchor">#</a> querystring</h3> <p><code>request.querystring</code>获取或设置请求的查询字符串。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">querystring</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">set</span> <span class="token function">querystring</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>search <span class="token operator">===</span> <span class="token template-string"><span class="token string">`?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>str<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  url<span class="token punctuation">.</span>search <span class="token operator">=</span> str<span class="token punctuation">;</span>
  url<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token function">stringify</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>设置<code>request.querystring</code>也会导致<code>request.url</code>的改变。</p> <h3 id="search"><a href="#search" aria-hidden="true" class="header-anchor">#</a> search</h3> <p><code>request.search</code>获取或设置请求的查询字符串。其结果会包含前置的<code>?</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>querystring<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>querystring<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">set</span> <span class="token function">search</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>querystring <span class="token operator">=</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p><code>request.path</code>，<code>request.query</code>，<code>request.querystring</code>，<code>request.search</code>的改变都会导致<code>request.url</code>的改变。</p></div> <h3 id="ips"><a href="#ips" aria-hidden="true" class="header-anchor">#</a> ips</h3> <p><code>request.ips</code>用来获取客户端的ip地址列表。如果在开启了代理模式，这个属性也会包含所有经过的代理服务器的<code>ip</code>地址。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">ips</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>proxy<span class="token punctuation">;</span>
  <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'X-Forwarded-For'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> proxy <span class="token operator">&amp;&amp;</span> val
    <span class="token operator">?</span> val<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s*,\s*/</span><span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>Koa</code>判断是否在代理模式下，是通过<code>app.proxy</code>属性判断。在获取<code>ip</code>地址的时候，会通过一个特殊的请求头<code>X-Forwarded-For</code>字段来获取所有经过的代理服务器的<code>ip</code>地址。这里先看一下这个字段是什么含义。</p> <p><code>X-Forwarded-For</code>是一个<code>HTTP</code>扩展头部，用来表示<code>HTTP</code>请求真实的<code>IP</code>。目前已经成为标准，被广大<code>HTTP</code>代理，负载均衡服务广泛使用。<code>X-Forwarded-For</code>请求头的格式如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>X-Forwarded-For: client, proxy1, proxy2<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>XFF</code>的内容由<code>[英文逗号 + 空格]</code>进行分隔，最开始的部分是离用户最远的设备的<code>ip</code>，然后是每一级代理的<code>ip</code>。</p> <p>比如，一个<code>HTTP</code>请求在到达服务器之前经历了三个代理<code>Proxy1</code>，<code>Proxy2</code>，<code>Proxy3</code>，<code>IP</code>地址分别是<code>IP1</code>，<code>IP2</code>，<code>IP3</code>，用户真实的<code>IP</code>地址为<code>IP0</code>，则根据标准，<code>X-Forwarded-For</code>的值就是<code>IP0, IP1, IP2</code>。因为<code>Proxy3</code>是直连服务器的，所以在列表中并不会出现<code>IP3</code>，<code>IP3</code>在服务端可以通过<code>Remote Address</code>进行获取。因为<code>HTTP</code>是基于<code>TCP</code>的连接，<code>Remote Address</code>来自<code>TCP</code>连接，表示与服务端建立连接的那个设备的<code>IP</code>。这个例子中就是<code>IP3</code>。而且这个<code>IP</code>地址是无法伪造的，在<code>Node.js</code>中我们可以通过<code>req.connection.remoteAddress</code>来获取。关于<code>X-Forwarded-For</code>更多的信息请参考<a href="https://imququ.com/post/x-forwarded-for-header-in-http.html" target="_blank" rel="noopener noreferrer">https://imququ.com/post/x-forwarded-for-header-in-http.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>明白了<code>X-Forwarded-For</code>字段的含义后，对于怎么获取<code>ips</code>的值就一目了然了。首先会判断如果在代理模式下，将<code>X-Forwarded-For</code>的值进行<code>split</code>后返回，否则就返回一个空数组。</p> <h3 id="ip"><a href="#ip" aria-hidden="true" class="header-anchor">#</a> ip</h3> <p><code>request.ip</code>属性默认以<code>request.ips</code>的第一个元素作为用户的<code>ip</code>地址，在这个值不存在的情况下，以<code>request.socket.remoteAddress</code>的值作为用户的<code>ip</code>地址。<code>request.socket</code>属性后面会讲到。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">IP</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">IP</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span>remoteAddress <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">IP</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token keyword">set</span> <span class="token function">ip</span><span class="token punctuation">(</span>_ip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">IP</span><span class="token punctuation">]</span> <span class="token operator">=</span> _ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="accepts内容协商属性"><a href="#accepts内容协商属性" aria-hidden="true" class="header-anchor">#</a> accepts内容协商属性</h3> <p>“内容协商”是<code>http</code>提供的一种机制，可以让服务器决定哪些资源最适合客户端。内容协商主要涉及到如下四个首部：</p> <ul><li><code>Accept</code>：告知服务器发送何种媒体类型</li> <li><code>Accept-Language</code>：告知服务器发送何种语言</li> <li><code>Accept-Charset</code>：告知服务器发送何种字符集</li> <li><code>Accept-Encoding</code>：告知服务器采用何种编码</li></ul> <p>服务器进行响应的时候，也会通过<code>响应头</code>明确表明资源的特性。上面四种协商首部对应的响应首部是<code>Content-Type</code>，<code>Content-Language</code>，<code>Content-Type</code>，<code>Content-Encoding</code>。</p> <p><code>Koa</code>中内容协商是通过<a href="https://www.npmjs.com/package/accepts" target="_blank" rel="noopener noreferrer">accepts<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>库进行判断的，针对上面四种内容协商头部都有对应的判断方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_accept <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_accept <span class="token operator">=</span> <span class="token function">accepts</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">set</span> <span class="token function">accept</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_accept <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">accepts</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accept<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">acceptsEncodings</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accept<span class="token punctuation">.</span><span class="token function">encodings</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">acceptsCharsets</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accept<span class="token punctuation">.</span><span class="token function">charsets</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">acceptsLanguages</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accept<span class="token punctuation">.</span><span class="token function">languages</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>其中<code>request.accepts</code>是对<code>Accept</code>头部的判断，<code>request.acceptsEncodings</code>是对<code>Accept-Encoding</code>头部的判断<code>request.acceptsCharsets</code>是对<code>Accept-Charset</code>头部的判断<code>request.acceptsLanguages</code>是对<code>Accept-Language</code>头部的判。</p> <h3 id="origin"><a href="#origin" aria-hidden="true" class="header-anchor">#</a> origin</h3> <p><code>request.origin</code>用于获取<code>url</code>的来源，包含<code>protocol</code>和<code>host</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">origin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="href"><a href="#href" aria-hidden="true" class="header-anchor">#</a> href</h3> <p><code>request.href</code>用于获取请求完整的<code>url</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">href</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// support: `GET http://example.com/foo`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^https?:\/\//i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>originalUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="host"><a href="#host" aria-hidden="true" class="header-anchor">#</a> host</h3> <p><code>request.host</code>用于获取当前主机。当 <code>app.proxy</code> 是 <code>true</code> 时支持 <code>X-Forwarded-Host</code>，否则使用 <code>Host</code>。</p> <p>获取<code>host</code>面临着和获取<code>ips</code>同样的情况，就是客户端并不是直连我们的服务器应用，可能会经过各种代理服务器。我们并不能直接通过<code>host</code>请求头获取客户端主机信息，同样会通过一个特殊的请求头<code>X-Forwarded-Host</code>获取客户端和代理服务器的<code>host</code>信息。</p> <p><code>X-Forwarded-Host</code>的含义就是<code>the original host requested by the client in the Host HTTP request header</code>。其实就是保存着客户端请求最原始的<code>host</code>信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果配置了app.proxy</span>
  <span class="token comment">// 就会从request header中获取X-Forwarded-Host解析host</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>proxy<span class="token punctuation">;</span>
  <span class="token keyword">let</span> host <span class="token operator">=</span> proxy <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'X-Forwarded-Host'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// http2 从:authority中获取</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>httpVersionMajor <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> host <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">':authority'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最后才会从 request Host这个header中获取</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>host<span class="token punctuation">)</span> host <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'Host'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>host<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果配置了多个，则取第一个</span>
  <span class="token keyword">return</span> host<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s*,\s*/</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p><code>host</code>包含域名和端口号</p></blockquote> <h3 id="hostname"><a href="#hostname" aria-hidden="true" class="header-anchor">#</a> hostname</h3> <p><code>request.hostname</code>用于获取请求的域名，不包含端口。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">hostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>host<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'['</span> <span class="token operator">==</span> host<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span>hostname <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span> <span class="token comment">// IPv6</span>
  <span class="token comment">// hostname不包含端口</span>
  <span class="token keyword">return</span> host<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="url-2"><a href="#url-2" aria-hidden="true" class="header-anchor">#</a> URL</h3> <p><code>request.URL</code>用于获取以<code>WHATWG parsed URL</code>方式解析的<code>url</code>。并把解析结果缓存在<code>request.memoizedURL</code>属性中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token constant">URL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* istanbul ignore else */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>memoizedURL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> protocol <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>protocol<span class="token punctuation">;</span>
    <span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">;</span>
    <span class="token keyword">const</span> originalUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originalUrl <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span> <span class="token comment">// avoid undefined in template string</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>originalUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 为什么不解析一下呢</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedURL <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedURL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="fresh"><a href="#fresh" aria-hidden="true" class="header-anchor">#</a> fresh</h3> <p><code>request.fresh</code>属性用于判断请求的内容是否有效。其实就是用来判断客户端缓存是否可用。这个方法主要是对协商缓存请求的判断，依赖请求头中的<code>If-None-Match</code>和<code>If-Modified-Since</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">fresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">;</span>
  <span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 检查请求缓存是否“新鲜”，也就是内容没有改变。此方法用于 If-None-Match / ETag, 
   * 和 If-Modified-Since 和 Last-Modified 之间的缓存协商。 
   * 在设置一个或多个这些响应头后应该引用它。
   */</span>
  <span class="token comment">// GET or HEAD for weak freshness validation only</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'GET'</span> <span class="token operator">!=</span> method <span class="token operator">&amp;&amp;</span> <span class="token string">'HEAD'</span> <span class="token operator">!=</span> method<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 2xx or 304 as per rfc2616 14.26</span>
  <span class="token comment">// 响应成功的时候才会去判断请求是否新鲜</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">304</span> <span class="token operator">==</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过对请求头和响应头的比较</span>
    <span class="token comment">// 判断客户端缓存是否可用</span>
    <span class="token keyword">return</span> <span class="token function">fresh</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>header<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>具体是怎么判断请求是否“新鲜”，主要是通过<a href="https://www.npmjs.com/package/fresh" target="_blank" rel="noopener noreferrer">fresh<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>库检验的，后续会对这个库进行解析。</p> <h3 id="stale"><a href="#stale" aria-hidden="true" class="header-anchor">#</a> stale</h3> <p><code>request.fresh</code>相反的含义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">stale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>fresh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="idempotent"><a href="#idempotent" aria-hidden="true" class="header-anchor">#</a> idempotent</h3> <p><code>request.idempotent</code>属性主要是用来判断请求方法是否是幂等的。<code>http</code>的幂等方法是指无论调用多少次都不会有不同结果的<code>http</code>方法。它无论是调用一次还是调用十次，结果都是一样的。<code>http</code>中幂等方法有<code>options</code>，<code>get</code>，<code>head</code>，<code>put</code>，<code>delete</code>，<code>trace</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">idempotent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'HEAD'</span><span class="token punctuation">,</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">,</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">,</span> <span class="token string">'TRACE'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token operator">~</span>methods<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="socket"><a href="#socket" aria-hidden="true" class="header-anchor">#</a> socket</h3> <p><code>request.socket</code>获取底层请求的<code>socket</code>连接。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>socket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="charset"><a href="#charset" aria-hidden="true" class="header-anchor">#</a> charset</h3> <p><code>request.charset</code>获请求头<code>Content-Type</code>中设置的<code>charset</code>。主要是通过<a href="https://www.npmjs.com/package/content-type" target="_blank" rel="noopener noreferrer">content-type<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>库进行解析。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">charset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> parameters <span class="token punctuation">}</span> <span class="token operator">=</span> contentType<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> parameters<span class="token punctuation">.</span>charset <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="length"><a href="#length" aria-hidden="true" class="header-anchor">#</a> length</h3> <p><code>request.length</code>主要用于获取请求体的长度，其实就是获取请求头部<code>Content-Length</code>的值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">~</span><span class="token operator">~</span>len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="protocol"><a href="#protocol" aria-hidden="true" class="header-anchor">#</a> protocol</h3> <p><code>request.protocol</code>用于获取客户端请求所使用的协议。<code>Koa</code>在获取请求所使用协议的时候，在某些情况下也会通过一个特殊的请求头<code>X-Forwarded-Proto</code>来判断。这个字段就是用来获取客户端和代理服务器以及负载均衡服务器之间的连接所采用的协议。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是https协议的请求，这个属性是true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span>encrypted<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'https'</span><span class="token punctuation">;</span>
  <span class="token comment">// 否则，在没有代理的情况下，直接返回http协议</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'http'</span><span class="token punctuation">;</span>

  <span class="token comment">// 有代理的情况下再通过X-Forwarded-Proto字段获取请求的协议</span>
  <span class="token comment">// X-Forwarded-Proto: https</span>
  <span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'X-Forwarded-Proto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> proto <span class="token operator">?</span> proto<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s*,\s*/</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">'http'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="secure"><a href="#secure" aria-hidden="true" class="header-anchor">#</a> secure</h3> <p><code>request.secure</code>用来判断请求是否采用了安全传输，其实就是请求协议是否是<code>https</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">secure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'https'</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>protocol<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="subdomains"><a href="#subdomains" aria-hidden="true" class="header-anchor">#</a> subdomains</h3> <p><code>request.subdomains</code>属性主要是用来获取子域名数组。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">subdomains</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置需要获取的子域的偏移量</span>
  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>subdomainOffset<span class="token punctuation">;</span>
  <span class="token keyword">const</span> hostname <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hostname<span class="token punctuation">;</span>
  <span class="token comment">// 测试 input 是否是 IP 地址。无效的字符串则返回 0，IPv4 地址则返回 4，IPv6的地址则返回 6。</span>
  <span class="token comment">// 如果你的hostname是 192.168.22.214这种情况，是无法判断子域的</span>
  <span class="token comment">// 直接返回一个空数组</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span><span class="token function">isIP</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> hostname
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="type"><a href="#type" aria-hidden="true" class="header-anchor">#</a> type</h3> <p><code>request.type</code>用于判断请求的资源类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> type<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="方法"><a href="#方法" aria-hidden="true" class="header-anchor">#</a> 方法</h2> <p><code>request</code>提供了便捷的方法<code>is</code>和<code>get</code>。</p> <h3 id="is"><a href="#is" aria-hidden="true" class="header-anchor">#</a> is</h3> <p><code>request.is</code>方法主要用于判断请求的<code>Content-Type</code>是否是给定类型中的一种。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">is</span><span class="token punctuation">(</span>types<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>types<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">typeis</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>types<span class="token punctuation">)</span><span class="token punctuation">)</span> types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">typeis</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">,</span> types<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="get"><a href="#get" aria-hidden="true" class="header-anchor">#</a> get</h3> <p><code>request.get</code>方法主要是用来获取请求头中某个字段的值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>field <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'referer'</span><span class="token punctuation">:</span>
    <span class="token keyword">case</span> <span class="token string">'referrer'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referrer <span class="token operator">||</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上面就是对<code>request</code>模块内容的全解析，后面我们会继续对<code>response</code>所提供的那些功能的探索。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/blog/assets/js/54.ae9432b6.js" defer></script><script src="/blog/assets/js/app.d624a2fd.js" defer></script>
  </body>
</html>
