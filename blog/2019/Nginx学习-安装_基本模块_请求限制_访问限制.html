<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx学习-安装基本模块请求限制_访问限制 | 赛赛的空间</title>
    <meta name="description" content="赵赛赛个人博客，关注前端技术，后端技术，喜欢编程。每天进步一点点就好啦！">
    <link rel="icon" type="image/x-icon" href="/blog/favicon.ico">
  <script type="text/javascript" src="/blog/bdtj.js"></script>
    
    <link rel="preload" href="/blog/assets/css/0.styles.626dd732.css" as="style"><link rel="preload" href="/blog/assets/js/app.90531a8f.js" as="script"><link rel="preload" href="/blog/assets/js/38.a6972860.js" as="script"><link rel="prefetch" href="/blog/assets/js/33.f60163cb.js"><link rel="prefetch" href="/blog/assets/js/2.285762ea.js"><link rel="prefetch" href="/blog/assets/js/3.8614e950.js"><link rel="prefetch" href="/blog/assets/js/4.f2c636f9.js"><link rel="prefetch" href="/blog/assets/js/5.f22e182a.js"><link rel="prefetch" href="/blog/assets/js/6.705c6a76.js"><link rel="prefetch" href="/blog/assets/js/7.1b37c5d0.js"><link rel="prefetch" href="/blog/assets/js/8.8c8fa426.js"><link rel="prefetch" href="/blog/assets/js/9.8be4c074.js"><link rel="prefetch" href="/blog/assets/js/10.f945838f.js"><link rel="prefetch" href="/blog/assets/js/11.49fcc2bd.js"><link rel="prefetch" href="/blog/assets/js/12.d3602b67.js"><link rel="prefetch" href="/blog/assets/js/13.70b305bb.js"><link rel="prefetch" href="/blog/assets/js/14.32cf3f5c.js"><link rel="prefetch" href="/blog/assets/js/15.21ca5469.js"><link rel="prefetch" href="/blog/assets/js/16.80a1f156.js"><link rel="prefetch" href="/blog/assets/js/17.d510fcbf.js"><link rel="prefetch" href="/blog/assets/js/18.0addd3df.js"><link rel="prefetch" href="/blog/assets/js/19.cde47560.js"><link rel="prefetch" href="/blog/assets/js/20.f2b3d7a0.js"><link rel="prefetch" href="/blog/assets/js/21.fb0dfbdc.js"><link rel="prefetch" href="/blog/assets/js/22.add6de0c.js"><link rel="prefetch" href="/blog/assets/js/23.b04f481b.js"><link rel="prefetch" href="/blog/assets/js/24.9b25b45f.js"><link rel="prefetch" href="/blog/assets/js/25.e3c8fc3b.js"><link rel="prefetch" href="/blog/assets/js/26.df213e6d.js"><link rel="prefetch" href="/blog/assets/js/27.26e0a740.js"><link rel="prefetch" href="/blog/assets/js/28.b173e962.js"><link rel="prefetch" href="/blog/assets/js/29.feee8832.js"><link rel="prefetch" href="/blog/assets/js/30.e1cfde92.js"><link rel="prefetch" href="/blog/assets/js/31.439fd555.js"><link rel="prefetch" href="/blog/assets/js/32.34d4c2ea.js"><link rel="prefetch" href="/blog/assets/js/34.e1f0e7a5.js"><link rel="prefetch" href="/blog/assets/js/35.f0e19097.js"><link rel="prefetch" href="/blog/assets/js/36.526ee101.js"><link rel="prefetch" href="/blog/assets/js/37.2a2d3f30.js"><link rel="prefetch" href="/blog/assets/js/39.8cacaa53.js"><link rel="prefetch" href="/blog/assets/js/40.88dc690c.js"><link rel="prefetch" href="/blog/assets/js/41.463140bd.js"><link rel="prefetch" href="/blog/assets/js/42.ae019df6.js"><link rel="prefetch" href="/blog/assets/js/43.d42d6e6d.js"><link rel="prefetch" href="/blog/assets/js/44.f572ff50.js"><link rel="prefetch" href="/blog/assets/js/45.8712f7f5.js"><link rel="prefetch" href="/blog/assets/js/46.8ddc4f12.js"><link rel="prefetch" href="/blog/assets/js/47.d412e955.js"><link rel="prefetch" href="/blog/assets/js/48.17943c10.js"><link rel="prefetch" href="/blog/assets/js/49.c9f777d6.js"><link rel="prefetch" href="/blog/assets/js/50.7961cea9.js"><link rel="prefetch" href="/blog/assets/js/51.f1e313e6.js"><link rel="prefetch" href="/blog/assets/js/52.582ffde9.js"><link rel="prefetch" href="/blog/assets/js/53.6ca59eee.js"><link rel="prefetch" href="/blog/assets/js/54.8d1a1a8f.js"><link rel="prefetch" href="/blog/assets/js/55.2a27c230.js"><link rel="prefetch" href="/blog/assets/js/56.7c54121b.js"><link rel="prefetch" href="/blog/assets/js/57.a9b3707f.js"><link rel="prefetch" href="/blog/assets/js/58.a61ecf2f.js"><link rel="prefetch" href="/blog/assets/js/59.053d804b.js"><link rel="prefetch" href="/blog/assets/js/60.c991880d.js"><link rel="prefetch" href="/blog/assets/js/61.dcb02945.js"><link rel="prefetch" href="/blog/assets/js/62.1c470d24.js"><link rel="prefetch" href="/blog/assets/js/63.6ff653ae.js"><link rel="prefetch" href="/blog/assets/js/64.30b980c1.js"><link rel="prefetch" href="/blog/assets/js/65.d1752ff7.js"><link rel="prefetch" href="/blog/assets/js/66.340bc90e.js"><link rel="prefetch" href="/blog/assets/js/67.d8167cf0.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.626dd732.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link"><img src="/blog/logo.png" alt="赛赛的空间" class="logo"> <span class="site-name can-hide">赛赛的空间</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/webkit.html" class="nav-link">Webkit</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">我的文章</a></div><div class="nav-item"><a href="/blog/good-writings.html" class="nav-link">阅读的好文</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/linux.html" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/blog/webkit.html" class="nav-link">Webkit</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/zhaosaisai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1>Nginx学习-安装_基本模块_请求限制_访问限制</h1> <p><code>Nginx</code>是目前一款主流的<code>web</code>服务器。<code>Nginx</code>相对于其它<code>web</code>服务器，比如，<code>tomcat</code>，<code>apache</code>等具有如下优点。</p> <h2 id="优势"><a href="#优势" aria-hidden="true" class="header-anchor">#</a> 优势</h2> <ul><li>高并发，高性能</li></ul> <p>很多web服务器随着并发连接的上升，<code>rps</code>会急剧下降。<code>nginx</code>高并发和高性能是同时具有的。</p> <ul><li>可扩展性好</li></ul> <p>可扩展性的主要体现在<code>Nginx</code>的模块化设计，第三方模块和生态圈是十分丰富的。</p> <ul><li>高可靠性</li></ul> <p>高可靠性主要体现在<code>Nginx</code>可以在服务器上持续不间断的运行数年。</p> <ul><li>热部署</li></ul> <p>体现在在不重启<code>Nginx</code>的情况下升级<code>Nginx</code>。</p> <h2 id="用途"><a href="#用途" aria-hidden="true" class="header-anchor">#</a> 用途</h2> <p>在实际的应用场景中，<code>Nginx</code>一般有如下几种用途：</p> <ul><li><p>静态资源服务</p> <ul><li>通过本地文件系统提供服务</li></ul></li> <li><p>反向代理服务</p> <ul><li>Nginx强大的性能</li> <li>缓存</li> <li>负载均衡</li></ul></li> <li><p>API 服务</p> <ul><li>OpenResty</li></ul></li></ul> <h2 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h2> <p><code>Nginx</code>的安装有源码编译和工具安装两种方式。因为我的服务器是<code>centos</code>，所以这里着重介绍如何通过<code>yum</code>来安装<code>Nginx</code>。</p> <p><code>yum</code>安装<code>Nginx</code>有如下步骤：</p> <ol><li>在<a href="http://nginx.org/en/linux_packages.html" target="_blank" rel="noopener noreferrer">nginx.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中根据自己的操作系统选择对应的安装方式。对于<code>centos</code>系统而言，我们可以选择通过<code>yum</code>的安装方式。所以，我们需要在系统中添加<code>Nginx</code>的<code>yum</code>源。</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 安装yum-utils</span>
yum <span class="token function">install</span> yum-utils
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后在文件<code>/etc/yum.repos.d/nginx.repo</code>中添加如下内容</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里我们安装的是<code>Nginx</code>的<code>stable</code>版本。当然你也可以选择安装<code>mainline</code>版本，安装方式可参考上述链接中提供的方法自行安装。为了确定我们的<code>yum</code>源安装成功，可以执行如下命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum list <span class="token operator">|</span> <span class="token function">grep</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果有如下输出，就表示安装成功。当然，不同的系统和版本输出可能会不一样</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>nginx.x86_64                      1.14.2-1.el6.ngx   @nginx-stable
nginx-module-geoip.x86_64         1.14.2-1.el6.ngx   @nginx-stable
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li><code>yum</code>源安装好之后，我们就可以直接<code>install</code>命令来安装<code>Nginx</code></li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token function">install</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>Nginx</code>安装成功后，可以执行如下命令查看<code>Nginx</code>的安装目录</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rpm -ql nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同样不同的系统和版本可能会有不同的输出</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>/etc/logrotate.d/nginx
/etc/nginx
/etc/nginx/conf.d
/etc/nginx/conf.d/default.conf
/etc/nginx/fastcgi_params
/etc/nginx/koi-utf
/etc/nginx/koi-win
/etc/nginx/mime.types
/etc/nginx/modules
/etc/nginx/nginx.conf
/etc/nginx/scgi_params
/etc/nginx/uwsgi_params
/etc/nginx/win-utf
/etc/rc.d/init.d/nginx
/etc/rc.d/init.d/nginx-debug
/etc/sysconfig/nginx
/etc/sysconfig/nginx-debug
/usr/lib64/nginx
/usr/lib64/nginx/modules
/usr/sbin/nginx
/usr/sbin/nginx-debug
/usr/share/doc/nginx-1.14.2
/usr/share/doc/nginx-1.14.2/COPYRIGHT
/usr/share/man/man8/nginx.8.gz
/usr/share/nginx
/usr/share/nginx/html
/usr/share/nginx/html/50x.html
/usr/share/nginx/html/index.html
/var/cache/nginx
/var/log/nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="nginx安装目录介绍"><a href="#nginx安装目录介绍" aria-hidden="true" class="header-anchor">#</a> Nginx安装目录介绍</h2> <p>为了能够更好的学习<code>Nginx</code>，我们需要对<code>Nginx</code>的安装目录有一个大致的了解。</p> <ul><li><p><code>/etc/logrotate.d/nginx</code>：配置文件。Nginx日志轮转，用于logrotate服务的日志切割</p></li> <li><p><code>/etc/nginx</code>：目录、配置文件。nginx的主配置文件</p> <ul><li><code>/etc/nginx/nginx.conf</code></li> <li><code>/etc/nginx/conf.d/*.conf</code></li></ul></li></ul> <p>cgi，fastcgi相关配置的配置文件</p> <ul><li><code>/etc/nginx/fastcgi_params</code></li> <li><code>/etc/nginx/uwsgi_params</code></li> <li><code>/etc/nginx/scgi_params</code></li></ul> <p>编码转换映射转化相关的配置文件</p> <ul><li><code>/etc/nginx/koi-utf</code></li> <li><code>/etc/nginx/koi-win</code></li> <li><code>/etc/nginx/win-utf</code></li></ul> <p>设置http协议content-type头部与扩展名的对应关系</p> <ul><li><code>/etc/nginx/mime.type</code></li></ul> <p>用于配制系统守护进程管理器管理方式</p> <ul><li><code>/etc/sysconfig/nginx</code></li> <li><code>/etc/sysconfig/nginx-debug</code></li></ul> <p>nginx模块目录</p> <ul><li><code>/etc/nginx/modules</code></li> <li><code>/usr/lib64/nginx/modules</code></li></ul> <p>nginx服务的启动管理终端命令</p> <ul><li><code>/usr/sbin/nginx</code></li> <li><code>/usr/sbin/nginx-debug</code></li></ul> <p>nginx的手册和帮助文件</p> <ul><li><code>/usr/share/doc/nginx-1.14.2</code></li> <li><code>/usr/share/doc/nginx-1.14.2/COPYRIGHT</code></li> <li><code>/usr/share/man/man8/nginx.8.gz</code></li></ul> <p>nginx的缓存目录</p> <ul><li><code>/var/cache/nginx</code></li></ul> <p>nginx的日志目录</p> <ul><li><code>/var/log/nginx</code></li></ul> <p>当然，上面的目录是<code>Nginx</code>安装成功后默认生成的目录。有一些目录我们可以根据自己的需要在配置文件中进行更改。</p> <h2 id="nginx命令"><a href="#nginx命令" aria-hidden="true" class="header-anchor">#</a> Nginx命令</h2> <p><code>Nginx</code>在运行的过程中可能会设计到如下命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 启动nginx，这种方式会使用默认的nginx配置文件。也就是/etc/nginx/nginx.conf</span>
nginx

<span class="token comment"># 启动nginx的时候指定配置文件</span>
nginx -c /etc/nginx/新的nginx配置文件

<span class="token comment"># 停止nginx</span>
nginx -s stop

<span class="token comment"># 重启nginx</span>
nginx -s reload

<span class="token comment"># 检查配置文件语法的准确性</span>
nginx -tc 配置文件路径
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="nginx日志"><a href="#nginx日志" aria-hidden="true" class="header-anchor">#</a> Nginx日志</h2> <p><code>Nginx</code>中的日志主要有两种：访问日志和错误日志。下面是<code>Nginx</code>安装的成功后默认的配置文件的部分内容</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">error_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log warn<span class="token punctuation">;</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
                      <span class="token string">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
                      <span class="token string">'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'</span><span class="token punctuation">;</span>

    <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>

    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>Nginx</code>的错误日志通过<code>error_log</code>指令配置，默认保存在<code>/var/log/nginx/error.log</code>文件中，日志的级别是<code>warn</code>。访问日志是通过<code>access_log</code>指令配置的，对于每一个<code>http</code>请求其访问日志默认保存在<code>/var/log/nginx/access.log</code>，日志的格式就是<code>main</code>所指向的<code>log_format</code>指令配置的。当然，对于访问日志你可以定义在<code>main</code>，<code>http</code>，<code>server</code>块中，不同的地方拥有不同的控制范围。日志的格式通过<code>log_format</code>指令配置，<code>log_format</code>的语法如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">log_format</span> name <span class="token punctuation">[</span>escape<span class="token operator">=</span>json<span class="token operator">|</span>default<span class="token punctuation">]</span> string<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在定义日志格式的时候，我们可以使用任意的<code>Nginx</code>变量。默认日志中所使用到的变量有</p> <ul><li>$remote_addr：表示客户端的地址</li> <li>$remote_user：表示客户端请求nginx认证的用户名，如果没有开启认证模块的话，这个是不会被记录的</li> <li>$time_local：表示nginx的时间</li> <li>$request：表示request头部的请求行。GET / HTTP/1.1等</li> <li>$status：表示的是响应状态码</li> <li>$body_bytes_sent：从服务端响应给客户端body的大小</li> <li>$http_referer：客户端referer</li> <li>$http_user_agent：客户端的user-agent字段</li> <li>$http_x_forwarded_for：每一级代理服务器的http信息</li></ul> <h2 id="nginx变量"><a href="#nginx变量" aria-hidden="true" class="header-anchor">#</a> Nginx变量</h2> <p><code>Nginx</code>中的变量主要有三种：内置变量，http请求变量和自定义变量。<code>Nginx</code>中的变量一般通过<code>$</code>进行获取。</p> <ol><li>http请求中的变量</li></ol> <p><code>http</code>请求中的变量并不是指唯一变量，而是有无限多变种的一种变量。主要有如下三种：</p> <ul><li>arg_PARAMETERS</li></ul> <p>这类变量就是用来获取当前请求中的参数值。比如我们的请求路径是<code>/arg?name=saisai&amp;age=25</code>。那我们就可以通过如下变量获取<code>name</code>和<code>age</code>对应的值。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>arg <span class="token punctuation">{</span>
  <span class="token comment"># 获取请求参数name的值</span>
  echo <span class="token string">&quot;$arg_name&quot;</span><span class="token punctuation">;</span>
  <span class="token comment"># 获取请求参数age的值</span>
  echo <span class="token string">&quot;$arg_age&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>http_HEADER</li></ul> <p>这类变量主要是用来获取请求头部中相关字段的值。比如获取<code>http</code>请求头部<code>user-agent</code>的值，可以通过变量<code>$http_user_agent</code>来获取。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>user_agent <span class="token punctuation">{</span>
  echo <span class="token string">&quot;$http_user_agent&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>sent_http_HEADER</li></ul> <p>当然，有请求就有响应。这类变量主要是用来获取<code>http</code>响应头信息。比如，获取响应头部中的<code>content-length</code>的值</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>content<span class="token operator">-</span>length <span class="token punctuation">{</span>
  echo <span class="token string">&quot;$sent_http_content_length&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>内置变量</li></ol> <p><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" target="_blank" rel="noopener noreferrer">内置变量<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是<code>Nginx</code>为我们提供的。比如上面定义日志格式的时候涉及到的一些内置变量。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
    <span class="token string">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
    <span class="token string">'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>自定义变量</li></ol> <p><code>Nginx</code>允许我们在配置文件中使用自定义变量。自定义变量通过<code>set</code>来指定。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">set</span> $变量名 变量值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>比如</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span> <span class="token variable">$hello</span> hello<span class="token punctuation">;</span>
  echo <span class="token string">&quot;$hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="nginx模块"><a href="#nginx模块" aria-hidden="true" class="header-anchor">#</a> Nginx模块</h2> <p><code>Nginx</code>是基于模块化的设计。<code>Nginx</code>中的模块也分为官方模块和第三方模块。可以通过如下命令来查看<code>Nginx</code>在安装的过程中所安装的一些模块。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>nginx -V
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-txt line-numbers-mode"><pre class="language-text"><code>nginx version: nginx/1.14.2
built by gcc 4.4.7 20120313 (Red Hat 4.4.7-23) (GCC)
built with OpenSSL 1.0.1e-fips 11 Feb 2013
TLS SNI support enabled
configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="http-stub-status-module"><a href="#http-stub-status-module" aria-hidden="true" class="header-anchor">#</a> http_stub_status_module</h3> <p>这个模块主要是用来查看<code>Nginx</code>当前的连接状态。通过在编译的时候添加<code>--with-http_stub_status_module</code>参数启动。</p> <p>模块启动后，可以通过指令<code>stub_status</code>配置。基本语法如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>Syntax<span class="token punctuation">:</span>	<span class="token keyword">stub_status</span><span class="token punctuation">;</span>
Default<span class="token punctuation">:</span> —
Context<span class="token punctuation">:</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>比如，<code>Nginx</code>有如下配置</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>mystatus <span class="token punctuation">{</span>
  <span class="token keyword">stub_status</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当我们访问<code>http://192.168.144.129/mystatus</code>会在网页中看到如下内容</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>Active connections<span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token comment"># nginx当前活跃的连接数</span>
<span class="token keyword">server</span> accepts handled requests
 <span class="token number">12</span> <span class="token number">12</span> <span class="token number">8</span> <span class="token comment"># 第一个12表示的是nginx处理的握手的总的次数 第二个12表示的nginx处理的连接数 第三个8表示nginx的总的连接数。正常情况下 第一个和第二个数字是相等的，表示没有丢失</span>
Reading<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 表示正在读取的数目</span>
Writing<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 表示正在写的连接数</span>
Waiting<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 表示建立的连接数。nginx在开启了keep-alive情况下</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="http-random-index-module"><a href="#http-random-index-module" aria-hidden="true" class="header-anchor">#</a> http_random_index_module</h3> <p>这个模块主要用于在主目录中随机选择一个文件作为主页，但这个模块是不会选择隐藏文件作为主页的。可以在编译的时候通过指定<code>--with-http_random_index_module</code>参数来指定。</p> <p>配置语法如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>Syntax<span class="token punctuation">:</span>	<span class="token keyword">random_index</span> on <span class="token operator">|</span> off<span class="token punctuation">;</span>
Default<span class="token punctuation">:</span> <span class="token keyword">random_index</span> off<span class="token punctuation">;</span>
Context<span class="token punctuation">:</span> <span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>假如我们的<code>Nginx</code>有如下配置</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">root</span>   <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token punctuation">;</span>
  <span class="token keyword">random_index</span> on<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>每次访问<code>http://192.168.144.129</code>都可能会看到一个随机的页面显示。</p> <h3 id="http-sub-module"><a href="#http-sub-module" aria-hidden="true" class="header-anchor">#</a> http_sub_module</h3> <p>这个模块主要用于对<code>http</code>响应中的内容进行替换。通过在编译的时候添加 <code>--with-http_sub_module</code> 参数启动。</p> <p>这个模块主要有如下几个指令配置：</p> <ul><li><strong>配置一：对body中返回的内容进行替换</strong></li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">sub_filter</span> string replacement<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token operator">/</span><span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>假设在我们的服务器上存在文件<code>/opt/app/code/index.html</code>，其内容如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>saisai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>zhao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>saisai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们的<code>Nginx</code>配置如下</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
  <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
  <span class="token comment"># 配置需要替换的内容</span>
  <span class="token keyword">sub_filter</span> <span class="token string">'&lt;a&gt;saisai'</span> <span class="token string">'&lt;a&gt;SAISAI'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>重启<code>Nginx</code>后，访问<code>http://192.168.144.129</code>。返回客户端的内容如下</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>SAISAI<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>zhao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>saisai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>默认情况下，<code>sub_filter</code>只会替换第一个匹配的内容。我们可以通过配置下面的指令来替换所有匹配的内容。</p> <ul><li><strong>配置二：对body中匹配的内容进行全部的替换</strong></li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">sub_filter_once</span> on <span class="token operator">|</span> off<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token keyword">sub_filter_once</span> on<span class="token punctuation">;</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token operator">/</span><span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同样是上面的<code>html</code>文件，如果我们的<code>Nginx</code>配置如下</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
  <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
  <span class="token comment"># 配置需要替换的内容</span>
  <span class="token keyword">sub_filter</span> <span class="token string">'&lt;a&gt;saisai'</span> <span class="token string">'&lt;a&gt;SAISAI'</span>
  <span class="token comment"># 替换所有匹配的内容</span>
  <span class="token keyword">sub_filter_once</span> off<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这时访问<code>http://192.168.144.129</code>。返回客户端的内容如下</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>SAISAI<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>zhao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">&gt;</span></span>SAISAI<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><strong>配置三：判断资源的内容是否更新。如果有更新返回最新文件，否则返回304；</strong></li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> sub_filter_last_modified on <span class="token operator">|</span> off<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> sub_filter_last_modified off<span class="token punctuation">;</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token operator">/</span><span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个配置是协商缓存的一种方式，依赖对<code>last-modified</code>和<code>if-modified-since</code>头部的判断。</p> <h2 id="nginx请求限制"><a href="#nginx请求限制" aria-hidden="true" class="header-anchor">#</a> Nginx请求限制</h2> <p><code>Nginx</code>对请求的限制主要包括两方面：连接频率的限制和请求频率的限制。其中，连接频率的限制通过模块<code>limit_conn_module</code>配置，请求频率的限制通过模块<code>limit_req_module</code>配置。</p> <p>为了区分上述两种限制的不同之处，我们得知道<code>连接</code>和<code>请求</code>有什么不同。</p> <p><img src="/blog/conn_req.png" alt></p> <p><code>连接</code>是指<code>connection</code>，即我们常说的<code>tcp</code>连接。建立一个<code>tcp</code>连接必须要通过三次握手。
<code>请求</code>是指<code>request</code>，即<code>http</code>请求。<code>http</code>请求是构建在<code>tcp</code>连接上的。</p> <p><code>tcp</code>连接是有状态的，而构建在tcp之上的http却是无状态的协议。在一个<code>tcp</code>连接的生命周期中，会存在一个或者多个请求，这主要是为了加快效率，避免每次请求都要三次握手建立连接，现在的<code>HTTP/1.1</code>协议都支持这种特性，叫做<code>keepalive</code>。</p> <p>明白了二者的区别后，就可以了解<code>Nginx</code>是怎么对这两种限制进行配置。</p> <ul><li>连接频率的限制</li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">limit_conn_zone</span> key zone<span class="token operator">=</span>name<span class="token punctuation">:</span>size<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过<code>limit_conn_zone</code>指令来设置限制的维度。<code>key</code>是维度变量。<code>zone</code>用来设置共享内存的名称和大小。比如，我们想基于客户端的<code>ip</code>地址进行限制，那么<code>key</code>就应该设置为客户端的<code>ip</code>地址<code>$remote_addr</code>。这个指令设置完成后，我们还需要通过<code>limit_conn</code>指令进行调用才能生效。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">limit_conn</span> zone number<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">location</span><span class="token punctuation">,</span> <span class="token keyword">server</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的配置是在<code>limit_conn_zone</code>配置好的基础上进行配置的。<code>zone</code>就是在<code>limit_conn_zone</code>中设置的名字，<code>number</code>就是限制的连接数。</p> <p>基于上述语法，我们可以对<code>nginx</code>进行如下配置来进行连接频率的限制</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>conn_zone<span class="token punctuation">:</span><span class="token number">1</span>m<span class="token punctuation">;</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
      <span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
      <span class="token comment"># 对连接进行限制</span>
      <span class="token keyword">limit_conn</span> conn_zone <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>请求频率的限制</li></ul> <p>请求频率的限制语法和上面的连接频率限制的语法相似</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">limit_req_zone</span> key zone<span class="token operator">=</span>name<span class="token punctuation">:</span>size rate<span class="token operator">=</span>rate<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>相对于连接频率的限制，在请求频率限制的配置中多了一个<code>rate</code>配置。用于设置最大的请求频率。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">limit_req</span> zone<span class="token operator">=</span>name <span class="token punctuation">[</span>burst<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>nodelay<span class="token punctuation">]</span><span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">location</span><span class="token punctuation">,</span> <span class="token keyword">server</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在<code>limit_req</code>中多了<code>burst</code>用来表示缓存住的请求数。<code>nodelay</code>用来表示是否希望请求延迟。比如下面的配置</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">limit_req</span>   zone<span class="token operator">=</span>req_one  burst<span class="token operator">=</span><span class="token number">120</span> nodelay<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>加上 <code>nodelay</code>之后超过 <code>burst</code>大小的请求就会直接返回503。</p> <p>下面是两个<code>Nginx</code>配置</p> <ul><li>配置一</li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token comment"># 下面配置的含义就是对于同一个客户端ip地址的请求限制在1s的时间内请求一个</span>
  <span class="token comment"># 其中这个zone的空间的大小是1m</span>
  <span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>req_zone<span class="token punctuation">:</span><span class="token number">1</span>m rate<span class="token operator">=</span><span class="token number">1</span>r<span class="token operator">/</span>s<span class="token punctuation">;</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
      <span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
      <span class="token comment"># 对请求进行限制</span>
      <span class="token keyword">limit_req</span> zone<span class="token operator">=</span>req_zone<span class="token punctuation">;</span>
      <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>然后通过ab进行测试</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ab -n 50 -c 2 http://192.168.144.129/1.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">..</span>.
Non-2xx responses:      49
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的配置表示对于同一个客户端ip地址的请求限制在1s的时间内请求一个。使用<code>ab</code>测试<code>50</code>个请求，会发现失败的请求数是<code>49</code>。</p> <ul><li>配置二</li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token comment"># 下面配置的含义就是对于同一个客户端ip地址的请求限制在1s的时间内请求一个</span>
  <span class="token comment"># 其中这个zone的空间的大小是1m</span>
  <span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>req_zone<span class="token punctuation">:</span><span class="token number">1</span>m rate<span class="token operator">=</span><span class="token number">1</span>r<span class="token operator">/</span>s<span class="token punctuation">;</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
      <span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
      <span class="token comment"># 对请求进行限制，当客户端的请求超过限制后，遗留三个请求到下一秒处理，其它的直接返回错误状态503</span>
      <span class="token keyword">limit_req</span> zone<span class="token operator">=</span>req_zone burst<span class="token operator">=</span><span class="token number">3</span> nodelay<span class="token punctuation">;</span>
      <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">..</span>.
Non-2xx responses:      46
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>Nginx</code>会成功处理1个请求，然后遗留3个请求到下一秒处理。所以，对于<code>ab</code>的<code>50</code>个请求会成功处理4个，失败<code>46</code>个。</p> <h2 id="nginx的访问控制"><a href="#nginx的访问控制" aria-hidden="true" class="header-anchor">#</a> Nginx的访问控制</h2> <p><code>Nginx</code>对于访问权限的控制也可以通过两个方面控制。一是基于<code>IP</code>的访问控制，二是基于用户的信任登录控制。</p> <p>基于<code>IP</code>的访问控制通过<code>http_access_module</code>模块来实现，基于用户的信任登录控制通过<code>http_auth_basic_module</code>模块来实现。</p> <h3 id="http-access-module"><a href="#http-access-module" aria-hidden="true" class="header-anchor">#</a> http_access_module</h3> <p>这个模块允许我们设置哪些<code>ip</code>地址可以或者不能访问我们的服务。配置语法如下：</p> <p><strong>1. 允许某些ip访问</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">allow</span> address <span class="token operator">|</span> CIDR <span class="token operator">|</span> unix<span class="token punctuation">:</span> <span class="token operator">|</span> All
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span><span class="token keyword">server</span><span class="token punctuation">,</span><span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>2. 拒绝某些ip访问</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">deny</span> address <span class="token operator">|</span> CIDR <span class="token operator">|</span> unix<span class="token punctuation">:</span> <span class="token operator">|</span> All
default<span class="token punctuation">:</span> <span class="token operator">--</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span><span class="token keyword">server</span><span class="token punctuation">,</span><span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>address: ip地址</li> <li>cidr: 网段地址</li> <li>unix: socket方式的访问</li> <li>all：所有的IP</li></ul> <p>下面是两个关于<code>ip</code>访问控制的配置。</p> <p><strong>测试一：不允许我的ip访问</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>admin<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
    <span class="token keyword">root</span>  <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code <span class="token punctuation">;</span>
    <span class="token keyword">deny</span> <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.1</span><span class="token punctuation">;</span>
    <span class="token keyword">allow</span> all<span class="token punctuation">;</span>
    <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>测试二：只允许我的ip访问</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>admin<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
    <span class="token keyword">root</span>  <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code <span class="token punctuation">;</span>
    <span class="token keyword">allow</span> <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.1</span><span class="token punctuation">;</span>
    <span class="token keyword">deny</span> all<span class="token punctuation">;</span>
    <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>上面的配置只能用于客户端直连Nginx服务才会起作用</p></div> <h3 id="auth-basic-module"><a href="#auth-basic-module" aria-hidden="true" class="header-anchor">#</a> auth_basic_module</h3> <p>这个模块要求客户端需要使用<code>HTTP Basic Authentication</code>协议进行用户名和密码的基本认证。我们需要使用<code>auth_basic</code>开启认证的功能，同时使用<code>auth_basic_user_file</code>指定用户登录的密钥文件。配置语法如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">auth_basic</span> string <span class="token operator">|</span> off<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token keyword">auth_basic</span> off<span class="token punctuation">;</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>string</code>就是用来设置前端的弹窗title，同时也表示开启用户认证。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>syntax<span class="token punctuation">:</span> <span class="token keyword">auth_basic_user_file</span> file<span class="token punctuation">;</span>
default<span class="token punctuation">:</span> <span class="token operator">--</span><span class="token punctuation">;</span>
context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>用户登录的密钥文件我们可以通过<code>htpasswd</code>生成，比如我们设置用户登录的用户名是<code>saisai</code>，可以通过如下命令生成加密密码</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>htpasswd -c ./auth_conf saisai
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>根据提示输入密码即可。</p> <p>下面是一段关于用户认证的配置</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>

	<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>admin<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
    <span class="token keyword">root</span>   <span class="token operator">/</span>opt<span class="token operator">/</span>app<span class="token operator">/</span>code<span class="token punctuation">;</span>
		<span class="token keyword">auth_basic</span> <span class="token string">&quot;Auth access test!input your password&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">auth_basic_user_file</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>auth_conf<span class="token punctuation">;</span>
    <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当用户访问<code>http://192.168.144.129/admin.html</code>的时候，客户端就会弹窗提示用户输入用户名和密码。只有输入了正确的用户名和密码，才能允许访问页面。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/blog/assets/js/38.a6972860.js" defer></script><script src="/blog/assets/js/app.90531a8f.js" defer></script>
  </body>
</html>
